
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#f8fafc" />
    
    <!-- Favicon & Icons -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2964/2964514.png" />
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2964/2964514.png" />
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="GymTracker" />
    
    <title>GymTracker Pro</title>
    
    <script src="https://unpkg.com/react@18.3.1/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.10/babel.min.js"></script>
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      #root:empty::before {
        content: "";
        display: block;
        width: 24px;
        height: 24px;
        margin: 45vh auto 0;
        border: 2px solid #e2e8f0;
        border-top-color: #0f172a;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      
      body {
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: contain;
        background-color: #f8fafc;
        height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      
      .fade-in {
        animation: fadeIn 0.2s ease-out forwards;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .tracker-item {
        position: relative;
        transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      }
      
      .tracker-item.dragging {
        opacity: 0.4;
        transform: scale(0.98);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      }

      .drag-handle {
        cursor: grab;
        touch-action: none;
      }
      .drag-handle:active {
        cursor: grabbing;
      }
      
      textarea {
        resize: none !important;
        overflow: hidden;
        appearance: none;
        -webkit-appearance: none;
      }

      .delete-btn-active {
        color: #ef4444 !important;
        background-color: #fef2f2;
        border-radius: 6px;
      }

      .action-button {
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
      }
      .action-button:active {
        transform: scale(0.92);
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
      }

      .secondary-button {
        transition: all 0.2s ease;
        @apply flex items-center justify-center px-8 py-3.5 rounded-2xl text-[12px] font-black uppercase tracking-widest border-2 border-slate-200 bg-white text-slate-600 shadow-md active:scale-95 active:bg-slate-50 active:border-slate-300;
      }

      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 200;
        padding: 12px 20px;
        border-radius: 99px;
        background: #0f172a;
        color: white;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        pointer-events: none;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .toast.show {
        opacity: 1;
        top: 30px;
      }

      .nav-btn {
        @apply p-1 text-slate-500 hover:text-slate-900 transition-all active:scale-125;
      }

      .modal-backdrop {
        background: rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      /* Suggestions Dropdown Improvements */
      .suggestions-list {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(226, 232, 240, 0.8);
        border-radius: 18px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.02);
        z-index: 500;
        max-height: 240px;
        overflow-y: auto;
        padding: 6px;
        animation: suggestionsIn 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        transform-origin: top center;
      }

      @keyframes suggestionsIn {
        from { opacity: 0; transform: translateY(-8px) scale(0.96); }
        to { opacity: 1; transform: translateY(0) scale(1); }
      }

      .suggestion-item {
        @apply px-4 py-2.5 text-[13px] font-bold text-slate-600 rounded-[12px] transition-all cursor-pointer;
        display: flex;
        align-items: center;
        margin-bottom: 2px;
        border: 1px solid transparent;
      }
      
      .suggestion-item:last-child {
        margin-bottom: 0;
      }

      .suggestion-item:active {
        @apply bg-slate-100 text-slate-900 border-slate-200/50;
        transform: scale(0.98);
      }

      /* Custom Range Style */
      input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
      }
      input[type=range]:focus {
        outline: none;
      }
      input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 6px;
        cursor: pointer;
        background: #e2e8f0;
        border-radius: 3px;
      }
      input[type=range]::-webkit-slider-thumb {
        height: 18px;
        width: 18px;
        border-radius: 50%;
        background: #0f172a;
        cursor: pointer;
        -webkit-appearance: none;
        margin-top: -6px;
      }

      /* Color Picker Hidden Hack */
      .color-picker-wrapper {
        position: relative;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid #e2e8f0;
        overflow: hidden;
      }
      .color-picker-wrapper input[type="color"] {
        position: absolute;
        top: -10px;
        left: -10px;
        width: 50px;
        height: 50px;
        cursor: pointer;
      }

      .mode-toggle {
        cursor: pointer;
        transition: opacity 0.2s;
        user-select: none;
      }
      .mode-toggle:active {
        opacity: 0.6;
      }

      .custom-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1rem;
      }

      /* Toggle Switch */
      .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 22px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #e2e8f0;
        transition: .4s;
        border-radius: 22px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 16px; width: 16px;
        left: 3px; bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #0f172a;
      }
      input:checked + .slider:before {
        transform: translateX(18px);
      }
    </style>
  </head>
  <body class="antialiased text-slate-900">
    <div id="root"></div>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered'))
            .catch(err => console.log('SW error', err));
        });
      }
    </script>

    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect, useRef, useMemo } = React;

      const i18n = {
        ru: {
          appName: "GymTracker",
          shopName: "ShopTracker",
          weight: "–í–µ—Å",
          kg: "–∫–≥",
          stats: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
          export: "–≠–∫—Å–ø–æ—Ä—Ç",
          import: "–ò–º–ø–æ—Ä—Ç",
          save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
          progress: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
          bodyWeight: "–í–µ—Å —Ç–µ–ª–∞",
          exerciseStats: "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è",
          selectExercise: "–í—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ",
          noData: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö",
          close: "–ó–∞–∫—Ä—ã—Ç—å",
          recordPlaceholder: "–ó–∞–ø–∏—Å—å...",
          shopPlaceholder: "–ö—É–ø–∏—Ç—å...",
          savedToast: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ üíæ",
          errorToast: "–û—à–∏–±–∫–∞ ‚ö†Ô∏è",
          exportToast: "–≠–∫—Å–ø–æ—Ä—Ç üì§",
          importToast: "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ",
          addExercise: "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ",
          addItem: "–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫",
          repeatLast: "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ—à–ª—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É",
          noPastData: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ü§∑‚Äç‚ôÇÔ∏è",
          copySuccess: "–ö–æ–ø–∏—è:",
          clearConfirm: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ?",
          clearBtn: "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏",
          clearedToast: "–û—á–∏—â–µ–Ω–æ üóëÔ∏è",
          settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
          language: "–Ø–∑—ã–∫",
          russian: "–†—É—Å—Å–∫–∏–π",
          english: "English",
          uiSettings: "–í–Ω–µ—à–Ω–∏–π –≤–∏–¥",
          uiSettingsGym: "–í–∏–¥: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞",
          uiSettingsShop: "–í–∏–¥: –ú–∞–≥–∞–∑–∏–Ω",
          itemHeight: "–í—ã—Å–æ—Ç–∞ –∑–∞–ø–∏—Å–∏",
          itemWidth: "–®–∏—Ä–∏–Ω–∞ –∑–∞–ø–∏—Å–∏",
          itemSpacing: "–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏",
          colorHighlight: "–°–µ—Ç",
          colorCompleted: "–ì–æ—Ç–æ–≤–æ",
          fontSize: "–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞",
          lineCount: "–ß–∏—Å–ª–æ —Å—Ç—Ä–æ–∫ –≤ –∑–∞–ø–∏—Å–∏",
          modeSwitched: "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ ",
          exerciseLibrary: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π",
          shopLibrary: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤",
          libraryEmpty: "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å—å.",
          count: "—Ä–∞–∑",
          start: "–ù–∞—á–∞—Ç—å",
          finish: "–ó–∞–∫–æ–Ω—á–∏—Ç—å",
          resetToast: "–í—Ä–µ–º—è —Å–±—Ä–æ—à–µ–Ω–æ ‚è±Ô∏è",
          workoutTime: "–í—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏",
          listNameLabel: "–ù–∞–∑–≤–∞–Ω–∏–µ",
          defaultListName: "–ù–æ–≤—ã–π —Å–ø–∏—Å–æ–∫",
          deleteEmptyLists: "–û—á–∏—Å—Ç–∏—Ç—å –ø—É—Å—Ç—ã–µ —Å–ø–∏—Å–∫–∏",
          addItemToLibrary: "–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É",
          editItemPlaceholder: "–ù–∞–∑–≤–∞–Ω–∏–µ...",
          alreadyExists: "–£–∂–µ –≤ —Å–ø–∏—Å–∫–µ!",
          toastDurationLabel: "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Å–µ–∫)",
          maxWorkoutTimeLabel: "–õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (—á–∞—Å)",
          enableToastsLabel: "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
          deleteListConfirm: "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ –∏ –≤—Å–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏?",
          listDeletedToast: "–°–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω üóëÔ∏è"
        },
        en: {
          appName: "GymTracker",
          shopName: "ShopTracker",
          weight: "Weight",
          kg: "kg",
          stats: "Stats",
          export: "Export",
          import: "Import",
          save: "Save",
          progress: "Statistics",
          bodyWeight: "Body Weight",
          exerciseStats: "Exercises",
          selectExercise: "Select exercise",
          noData: "Not enough data",
          close: "Close",
          recordPlaceholder: "Record...",
          shopPlaceholder: "Buy...",
          savedToast: "Saved üíæ",
          errorToast: "Error ‚ö†Ô∏è",
          exportToast: "Exported üì§",
          importToast: "Imported ‚úÖ",
          addExercise: "Add Exercise",
          addItem: "Add to List",
          repeatLast: "Repeat last workout",
          noPastData: "No data ü§∑‚Äç‚ôÇÔ∏è",
          copySuccess: "Copied:",
          clearConfirm: "Confirm clear?",
          clearBtn: "Delete all records",
          clearedToast: "Cleared üóëÔ∏è",
          settings: "Settings",
          language: "Language",
          russian: "Russian",
          english: "English",
          uiSettings: "Appearance",
          uiSettingsGym: "UI: Gym Mode",
          uiSettingsShop: "UI: Shop Mode",
          itemHeight: "Item Height",
          itemWidth: "Item Width",
          itemSpacing: "Item Spacing",
          colorHighlight: "Set Color",
          colorCompleted: "Done Color",
          fontSize: "Font Size",
          lineCount: "Number of Lines",
          modeSwitched: "Switched to ",
          exerciseLibrary: "Exercise Library",
          shopLibrary: "Shop Library",
          libraryEmpty: "Library is empty. Add items.",
          count: "times",
          start: "Start",
          finish: "Finish",
          resetToast: "Timer reset ‚è±Ô∏è",
          workoutTime: "Workout Time",
          listNameLabel: "List Name",
          defaultListName: "New List",
          deleteEmptyLists: "Clear empty lists",
          addItemToLibrary: "Add to library",
          editItemPlaceholder: "Name...",
          alreadyExists: "Already exists!",
          toastDurationLabel: "Toast duration (sec)",
          maxWorkoutTimeLabel: "Workout time limit (hrs)",
          enableToastsLabel: "Show notifications",
          deleteListConfirm: "Delete this list and all its items?",
          listDeletedToast: "List deleted üóëÔ∏è"
        }
      };

      const DB_NAME = 'TrackerDB';
      const STORE_RECORDS = 'records';
      const STORE_WEIGHTS = 'weights';
      const STORE_SESSIONS = 'sessions';
      const DB_VERSION = 4;

      const initDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_RECORDS)) {
              db.createObjectStore(STORE_RECORDS, { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains(STORE_WEIGHTS)) {
              db.createObjectStore(STORE_WEIGHTS, { keyPath: 'dateKey' });
            }
            if (!db.objectStoreNames.contains(STORE_SESSIONS)) {
              db.createObjectStore(STORE_SESSIONS, { keyPath: 'dateKey' });
            }
          };
          request.onsuccess = (e) => resolve(e.target.result);
          request.onerror = (e) => reject(e.target.error);
        });
      };

      const saveToDB = async (records) => {
        if (!records) return;
        const db = await initDB();
        const tx = db.transaction(STORE_RECORDS, 'readwrite');
        const store = tx.objectStore(STORE_RECORDS);
        
        return new Promise((resolve, reject) => {
          const clearReq = store.clear();
          clearReq.onsuccess = () => {
            if (records.length === 0) {
              resolve();
              return;
            }
            records.forEach((r, index) => {
              store.put({ ...r, sortOrder: index });
            });
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
          };
          clearReq.onerror = () => reject(clearReq.error);
        });
      };

      const loadFromDB = async () => {
        const db = await initDB();
        const tx = db.transaction(STORE_RECORDS, 'readonly');
        const store = tx.objectStore(STORE_RECORDS);
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => {
            const results = request.result || [];
            const sorted = results.sort((a, b) => (a.sortOrder ?? 0) - (b.sortOrder ?? 0));
            resolve(sorted);
          };
        });
      };

      const saveWeightToDB = async (dateKey, weight) => {
        const db = await initDB();
        const tx = db.transaction(STORE_WEIGHTS, 'readwrite');
        const store = tx.objectStore(STORE_WEIGHTS);
        return new Promise((resolve, reject) => {
          store.put({ dateKey, weight });
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      };

      const loadWeightsFromDB = async () => {
        const db = await initDB();
        const tx = db.transaction(STORE_WEIGHTS, 'readonly');
        const store = tx.objectStore(STORE_WEIGHTS);
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => {
            const weightsMap = {};
            request.result.forEach(item => { weightsMap[item.dateKey] = item.weight; });
            resolve(weightsMap);
          };
        });
      };

      const saveSessionToDB = async (dateKey, session) => {
        const db = await initDB();
        const tx = db.transaction(STORE_SESSIONS, 'readwrite');
        const store = tx.objectStore(STORE_SESSIONS);
        return new Promise((resolve, reject) => {
          store.put({ dateKey, ...session });
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      };

      const loadSessionsFromDB = async () => {
        const db = await initDB();
        const tx = db.transaction(STORE_SESSIONS, 'readonly');
        const store = tx.objectStore(STORE_SESSIONS);
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => {
            const sessionsMap = {};
            request.result.forEach(item => { 
                const { dateKey, ...rest } = item;
                sessionsMap[dateKey] = rest; 
            });
            resolve(sessionsMap);
          };
        });
      };

      const getDateKey = (date) => {
        const d = new Date(date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      };

      const LibraryEditor = ({ items, onAdd, onDelete, onEdit, t, placeholder }) => {
        const [newItem, setNewItem] = useState('');
        
        const handleAdd = () => {
          if (!newItem.trim()) return;
          if (items.includes(newItem.trim())) {
             alert(t.alreadyExists);
             return;
          }
          onAdd(newItem.trim());
          setNewItem('');
        };

        return (
          <div className="flex flex-col gap-3">
            <div className="flex gap-2">
              <input 
                type="text" 
                value={newItem} 
                onChange={(e) => setNewItem(e.target.value)} 
                onKeyDown={(e) => e.key === 'Enter' && handleAdd()}
                placeholder={placeholder || t.addItemToLibrary} 
                className="flex-1 bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm font-semibold focus:ring-2 focus:ring-slate-900 focus:outline-none" 
              />
              <button onClick={handleAdd} className="p-2.5 bg-slate-900 text-white rounded-xl active:scale-95 transition-transform">
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M12 6v12m6-6H6" /></svg>
              </button>
            </div>
            
            <div className="bg-slate-50 rounded-2xl border border-slate-100 overflow-hidden max-h-[300px] overflow-y-auto">
              {items.length > 0 ? (
                items.map((item, index) => (
                  <div key={index} className="flex items-center px-4 py-2.5 border-b border-slate-100 last:border-0 gap-3 group">
                    <input 
                      type="text" 
                      value={item} 
                      onChange={(e) => onEdit(index, e.target.value)}
                      className="flex-1 bg-transparent border-none outline-none text-sm font-bold text-slate-700 focus:text-slate-900 p-0"
                    />
                    <button onClick={() => onDelete(index)} className="p-1.5 text-slate-300 hover:text-red-500 transition-colors">
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                  </div>
                ))
              ) : (
                <div className="p-8 text-center text-xs font-bold text-slate-400 italic">
                  {t.libraryEmpty}
                </div>
              )}
            </div>
          </div>
        );
      };

      const SettingsModal = ({ 
        isOpen, onClose, language, setLanguage, uiSettings, setUiSettings, 
        activeMode, exerciseRegistry, setExerciseRegistry, shopRegistry, setShopRegistry, 
        clearRegistry, t 
      }) => {
        if (!isOpen) return null;

        const currentUISettings = uiSettings[activeMode];

        const updateUI = (key, val) => {
          setUiSettings(prev => ({
            ...prev,
            [activeMode]: {
              ...prev[activeMode],
              [key]: val
            }
          }));
        };

        const currentRegistry = activeMode === 'gym' ? exerciseRegistry : shopRegistry;
        const setRegistry = activeMode === 'gym' ? setExerciseRegistry : setShopRegistry;
        const libraryTitle = activeMode === 'gym' ? t.exerciseLibrary : t.shopLibrary;

        const handleAdd = (val) => setRegistry(prev => [...prev, val].sort((a,b) => a.localeCompare(b)));
        const handleDelete = (index) => setRegistry(prev => prev.filter((_, i) => i !== index));
        const handleEdit = (index, val) => setRegistry(prev => {
          const next = [...prev];
          next[index] = val;
          return next;
        });

        return (
          <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 modal-backdrop fade-in">
            <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-y-auto max-h-[90vh] flex flex-col">
              <div className="px-6 pt-6 pb-2 flex justify-between items-center border-b border-slate-50 sticky top-0 bg-white z-10">
                <h2 className="text-xl font-black text-slate-900 tracking-tight">{t.settings}</h2>
                <button onClick={onClose} className="p-2 -mr-2 text-slate-400">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              
              <div className="p-6 flex flex-col gap-8">
                {/* Language Section */}
                <div>
                  <label className="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3">{t.language}</label>
                  <div className="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-xl">
                    <button 
                      onClick={() => setLanguage('ru')}
                      className={`py-2 rounded-lg text-xs font-bold transition-all ${language === 'ru' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}
                    >
                      {t.russian}
                    </button>
                    <button 
                      onClick={() => setLanguage('en')}
                      className={`py-2 rounded-lg text-xs font-bold transition-all ${language === 'en' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}
                    >
                      {t.english}
                    </button>
                  </div>
                </div>

                {/* UI Customization Section */}
                <div className="flex flex-col gap-4">
                  <label className="block text-[10px] font-black uppercase tracking-widest text-slate-400">
                    {activeMode === 'gym' ? t.uiSettingsGym : t.uiSettingsShop}
                  </label>
                  
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <span className="text-[11px] font-bold text-slate-600">{t.enableToastsLabel}</span>
                      <label className="switch">
                        <input 
                          type="checkbox" 
                          checked={currentUISettings.enableToasts !== false} 
                          onChange={(e) => updateUI('enableToasts', e.target.checked)} 
                        />
                        <span className="slider"></span>
                      </label>
                    </div>

                    <div>
                      <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1">
                        <span>{t.toastDurationLabel}</span>
                        <span>{currentUISettings.toastDuration || 3}—Å</span>
                      </div>
                      <input type="range" min="1" max="15" step="1" value={currentUISettings.toastDuration || 3} onChange={(e) => updateUI('toastDuration', parseInt(e.target.value))} />
                    </div>

                    {activeMode === 'gym' && (
                      <div>
                        <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1">
                          <span>{t.maxWorkoutTimeLabel}</span>
                          <span>{currentUISettings.maxWorkoutTime || 4}—á</span>
                        </div>
                        <input type="range" min="1" max="24" step="1" value={currentUISettings.maxWorkoutTime || 4} onChange={(e) => updateUI('maxWorkoutTime', parseInt(e.target.value))} />
                      </div>
                    )}

                    <div>
                      <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1">
                        <span>{t.fontSize}</span>
                        <span>{currentUISettings.fontSize}px</span>
                      </div>
                      <input type="range" min="8" max="24" step="1" value={currentUISettings.fontSize} onChange={(e) => updateUI('fontSize', parseInt(e.target.value))} />
                    </div>
                    <div>
                      <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1">
                        <span>{t.lineCount}</span>
                        <span>{currentUISettings.lineCount}</span>
                      </div>
                      <input type="range" min="1" max="6" step="1" value={currentUISettings.lineCount} onChange={(e) => updateUI('lineCount', parseInt(e.target.value))} />
                    </div>
                    <div>
                      <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1">
                        <span>{t.itemHeight}</span>
                        <span>{currentUISettings.itemHeight}px</span>
                      </div>
                      <input type="range" min="30" max="120" step="2" value={currentUISettings.itemHeight} onChange={(e) => updateUI('itemHeight', parseInt(e.target.value))} />
                    </div>
                    <div>
                      <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1">
                        <span>{t.itemWidth}</span>
                        <span>{currentUISettings.itemWidth}%</span>
                      </div>
                      <input type="range" min="70" max="100" step="1" value={currentUISettings.itemWidth} onChange={(e) => updateUI('itemWidth', parseInt(e.target.value))} />
                    </div>
                    <div>
                      <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1">
                        <span>{t.itemSpacing}</span>
                        <span>{currentUISettings.itemSpacing}px</span>
                      </div>
                      <input type="range" min="0" max="32" step="2" value={currentUISettings.itemSpacing} onChange={(e) => updateUI('itemSpacing', parseInt(e.target.value))} />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      {activeMode === 'gym' && (
                        <div className="flex items-center gap-3">
                          <div className="color-picker-wrapper" style={{ backgroundColor: currentUISettings.highlightColor }}>
                            <input type="color" value={currentUISettings.highlightColor} onChange={(e) => updateUI('highlightColor', e.target.value)} />
                          </div>
                          <span className="text-[10px] font-bold text-slate-500 uppercase">{t.colorHighlight}</span>
                        </div>
                      )}
                      <div className="flex items-center gap-3">
                        <div className="color-picker-wrapper" style={{ backgroundColor: currentUISettings.completedColor }}>
                          <input type="color" value={currentUISettings.completedColor} onChange={(e) => updateUI('completedColor', e.target.value)} />
                        </div>
                        <span className="text-[10px] font-bold text-slate-500 uppercase">{t.colorCompleted}</span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Library Section with Manual Edits */}
                <div className="flex flex-col gap-3">
                  <div className="flex justify-between items-center">
                    <label className="block text-[10px] font-black uppercase tracking-widest text-slate-400">
                      {libraryTitle}
                    </label>
                  </div>
                  
                  <LibraryEditor 
                    items={currentRegistry} 
                    onAdd={handleAdd} 
                    onDelete={handleDelete} 
                    onEdit={handleEdit} 
                    t={t} 
                    placeholder={t.editItemPlaceholder}
                  />
                </div>
              </div>

              <div className="px-6 pb-6 pt-2 sticky bottom-0 bg-white">
                <button onClick={onClose} className="w-full py-3 bg-slate-900 text-white font-bold rounded-xl active:scale-95">{t.close}</button>
              </div>
            </div>
          </div>
        );
      };

      const StatsModal = ({ isOpen, onClose, weights, records, knownExercises, t }) => {
        const [activeTab, setActiveTab] = useState('body');
        const [selectedExercise, setSelectedExercise] = useState('');
        const canvasRef = useRef(null);
        const chartInstance = useRef(null);

        useEffect(() => {
          if (!selectedExercise && knownExercises.length > 0) {
            setSelectedExercise(knownExercises[0]);
          }
        }, [knownExercises]);

        useEffect(() => {
          if (isOpen && canvasRef.current) {
            let labels = [];
            let data = [];
            let labelText = '';

            if (activeTab === 'body') {
              const sortedEntries = Object.entries(weights)
                .filter(([_, val]) => val !== '' && val !== null)
                .sort((a, b) => new Date(a[0]) - new Date(b[0]));

              if (sortedEntries.length > 0) {
                labels = sortedEntries.map(([date]) => {
                  const d = new Date(date);
                  return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                });
                data = sortedEntries.map(([_, val]) => parseFloat(val));
                labelText = t.weight;
              }
            } else {
              if (selectedExercise) {
                const exerciseRecords = records.filter(r => r.description.trim() === selectedExercise);
                const groupedByDate = {};
                
                exerciseRecords.forEach(r => {
                  const vals = [parseFloat(r.val1), parseFloat(r.val2), parseFloat(r.val3)].filter(v => !isNaN(v));
                  if (vals.length > 0) {
                    const maxVal = Math.max(...vals);
                    if (!groupedByDate[r.dateKey] || maxVal > groupedByDate[r.dateKey]) {
                      groupedByDate[r.dateKey] = maxVal;
                    }
                  }
                });

                const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(a) - new Date(b));
                labels = sortedDates.map(date => {
                  const d = new Date(date);
                  return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                });
                data = sortedDates.map(date => groupedByDate[date]);
                labelText = selectedExercise;
              }
            }

            if (chartInstance.current) { chartInstance.current.destroy(); }
            
            if (data.length > 0) {
              const ctx = canvasRef.current.getContext('2d');
              chartInstance.current = new Chart(ctx, {
                type: 'line',
                data: {
                  labels,
                  datasets: [{
                    label: labelText,
                    data,
                    borderColor: '#0f172a',
                    backgroundColor: 'rgba(15, 23, 42, 0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#0f172a',
                    pointRadius: 4,
                    pointHoverRadius: 6
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { display: false } },
                  scales: {
                    y: { beginAtZero: false, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } },
                    x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                  }
                }
              });
            }
          }
        }, [isOpen, weights, records, activeTab, selectedExercise, t]);

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-backdrop fade-in">
            <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
              <div className="px-6 pt-6 pb-2 flex justify-between items-center border-b border-slate-50">
                <h2 className="text-xl font-black text-slate-900 tracking-tight">{t.progress}</h2>
                <button onClick={onClose} className="p-2 -mr-2 text-slate-400">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <div className="px-6 pt-4">
                <div className="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-xl">
                  <button onClick={() => setActiveTab('body')} className={`py-2 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${activeTab === 'body' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}>{t.bodyWeight}</button>
                  <button onClick={() => setActiveTab('exercises')} className={`py-2 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${activeTab === 'exercises' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}>{t.exerciseStats}</button>
                </div>
              </div>

              <div className="flex-1 flex flex-col min-h-[350px]">
                {activeTab === 'exercises' && (
                  <div className="p-6 pb-0">
                    <select value={selectedExercise} onChange={(e) => setSelectedExercise(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold text-slate-700 custom-select focus:ring-2 focus:ring-slate-900 focus:outline-none">
                      <option value="" disabled>{t.selectExercise}</option>
                      {knownExercises.map(ex => (<option key={ex} value={ex}>{ex}</option>))}
                    </select>
                  </div>
                )}
                <div className="flex-1 relative p-6">
                  {(activeTab === 'body' ? Object.keys(weights).filter(k => weights[k] !== '' && weights[k] !== null).length > 0 : (selectedExercise && records.some(r => r.description.trim() === selectedExercise && (r.val1 || r.val2 || r.val3)))) ? (
                    <canvas ref={canvasRef}></canvas>
                  ) : (
                    <div className="h-full flex flex-col items-center justify-center text-slate-300 gap-4">
                      <p className="text-sm font-bold uppercase tracking-widest text-center">{t.noData}</p>
                    </div>
                  )}
                </div>
              </div>
              <div className="px-6 pb-6 pt-2">
                <button onClick={onClose} className="w-full py-3 bg-slate-100 text-slate-900 font-bold rounded-xl active:scale-95">{t.close}</button>
              </div>
            </div>
          </div>
        );
      };

      const TrackerItem = ({ record, index, onDelete, onUpdate, onDragStart, onDragOver, onDragEnd, isDragging, uiSettings, mode, knownItems, t }) => {
        const [isConfirming, setIsConfirming] = useState(false);
        const [showSuggestions, setShowSuggestions] = useState(false);
        const textRef = useRef(null);
        const confirmTimeout = useRef(null);
        const suggestionsRef = useRef(null);

        useEffect(() => {
          if (record.isNew && textRef.current) {
            textRef.current.focus();
            onUpdate(record.id, 'isNew', false);
          }
        }, []);

        const filteredSuggestions = useMemo(() => {
          if (!record.description || record.description.length < 1) return [];
          const query = record.description.toLowerCase().trim();
          return knownItems.filter(item => item.toLowerCase().includes(query) && item.toLowerCase() !== query).slice(0, 5);
        }, [record.description, knownItems]);

        const handleDeleteClick = (e) => {
          e.preventDefault();
          if (isConfirming) { onDelete(record.id); } else {
            setIsConfirming(true);
            if (confirmTimeout.current) clearTimeout(confirmTimeout.current);
            confirmTimeout.current = setTimeout(() => setIsConfirming(false), 3000);
          }
        };

        const handleSuggestionClick = (val) => {
          onUpdate(record.id, 'description', val);
          setShowSuggestions(false);
        };

        const handleBlur = () => {
          setTimeout(() => setShowSuggestions(false), 200);
          const finalVal = record.description.trim();
          if (finalVal !== record.description) {
            onUpdate(record.id, 'description', finalVal);
          }
        };

        const itemStyles = {
          height: `${uiSettings.itemHeight}px`,
          width: `${uiSettings.itemWidth}%`,
          marginBottom: `${uiSettings.itemSpacing}px`,
          backgroundColor: 'white',
          borderWidth: '1px',
          borderColor: '#e2e8f0',
          zIndex: (showSuggestions && filteredSuggestions.length > 0) ? 500 : 1,
          position: 'relative'
        };

        if (record.isCompleted && record.isHighlighted && mode === 'gym') {
           itemStyles.backgroundColor = uiSettings.completedColor;
           itemStyles.borderColor = uiSettings.highlightColor;
           itemStyles.boxShadow = `0 0 0 2px ${uiSettings.highlightColor} inset`;
        } else if (record.isCompleted) {
           itemStyles.backgroundColor = uiSettings.completedColor;
           itemStyles.borderColor = '#cbd5e1';
        } else if (record.isHighlighted && mode === 'gym') {
           itemStyles.backgroundColor = uiSettings.highlightColor;
           itemStyles.borderColor = '#cbd5e1';
        }

        return (
          <div draggable="true" onDragStart={(e) => onDragStart(e, index)} onDragOver={(e) => onDragOver(e, index)} onDragEnd={onDragEnd} style={itemStyles} className={`mx-auto rounded-lg pl-0.5 pr-0.5 flex items-center shadow-sm fade-in tracker-item transition-all duration-200 ${isDragging ? 'dragging' : ''}`}>
            <div className="flex items-center drag-handle px-0.5 shrink-0 h-full">
              <div className="flex flex-col gap-0.5 opacity-20">{[1, 2, 3].map(i => (<div key={i} className="flex gap-0.5"><div className="w-0.5 h-0.5 bg-slate-900 rounded-full"></div><div className="w-0.5 h-0.5 bg-slate-900 rounded-full"></div></div>))}</div>
            </div>
            <div className="flex flex-col items-center gap-0.5 shrink-0 px-0.5 py-0.5">
              {mode === 'gym' && (
                <button onClick={() => onUpdate(record.id, 'isHighlighted', !record.isHighlighted)} className={`p-0.5 transition-all active:scale-90 ${record.isHighlighted ? 'text-slate-700' : 'text-slate-300'}`}>
                  <svg className="w-3.5 h-3.5" fill={record.isHighlighted ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" strokeWidth="4" /></svg>
                </button>
              )}
              <button onClick={() => onUpdate(record.id, 'isCompleted', !record.isCompleted)} className={`p-0.5 transition-all active:scale-90 ${record.isCompleted ? 'text-emerald-600' : 'text-slate-300'}`}>
                <svg className="w-3.5 h-3.5" fill={record.isCompleted ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={6} d="M5 13l4 4L19 7" /></svg>
              </button>
            </div>
            <div className="flex-1 min-w-0 py-0.5 ml-1 h-full flex items-center relative">
              <textarea ref={textRef} rows={uiSettings.lineCount || 2} value={record.description} onFocus={() => setShowSuggestions(true)} onBlur={handleBlur} onChange={(e) => { onUpdate(record.id, 'description', e.target.value); setShowSuggestions(true); }} placeholder={mode === 'gym' ? t.recordPlaceholder : t.shopPlaceholder} style={{ fontSize: `${uiSettings.fontSize || 12}px` }} className={`font-semibold bg-transparent border-none outline-none focus:ring-0 placeholder:text-slate-300 w-full p-0 m-0 leading-tight ${(record.isHighlighted && mode === 'gym') || record.isCompleted ? 'text-black' : 'text-slate-700'} ${record.isCompleted ? 'opacity-50' : ''}`} />
              {showSuggestions && filteredSuggestions.length > 0 && (<div className="suggestions-list" ref={suggestionsRef}>{filteredSuggestions.map(s => (<div key={s} onMouseDown={() => handleSuggestionClick(s)} className="suggestion-item">{s}</div>))}</div>)}
            </div>
            {mode === 'gym' && (
              <div className="flex items-center gap-0.5 shrink-0 px-0.5">
                {['val1', 'val2', 'val3'].map((f) => (<input key={f} type="text" inputMode="numeric" value={record[f] || ''} onChange={(e) => onUpdate(record.id, f, e.target.value.replace(/\D/g, '').slice(0, 3))} className={`w-6 h-6 text-center border border-slate-100 rounded-md text-[11px] font-bold focus:outline-none focus:border-slate-400 bg-slate-50/50 shadow-inner p-0 ${record.isHighlighted || record.isCompleted ? 'text-black' : 'text-slate-900'}`} placeholder="0" />))}
              </div>
            )}
            <button onClick={handleDeleteClick} className={`w-7 h-7 shrink-0 flex items-center justify-center transition-all ${isConfirming ? 'delete-btn-active' : 'text-slate-900'}`}>
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
          </div>
        );
      };

      const App = () => {
        const [records, setRecords] = useState([]);
        const [weights, setWeights] = useState({});
        const [sessions, setSessions] = useState({});
        const [language, setLanguage] = useState(localStorage.getItem('gt_lang') || 'ru');
        const [mode, setMode] = useState(localStorage.getItem('gt_mode') || 'gym');
        
        // –ú–∞–Ω—É–∞–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (—Ä–µ–µ—Å—Ç—Ä—ã)
        const [exerciseRegistry, setExerciseRegistry] = useState(() => {
          const saved = localStorage.getItem('gt_exercise_registry');
          return saved ? JSON.parse(saved) : [];
        });
        const [shopRegistry, setShopRegistry] = useState(() => {
          const saved = localStorage.getItem('gt_shop_registry');
          return saved ? JSON.parse(saved) : [];
        });

        const [shopListRegistry, setShopListRegistry] = useState(() => {
          const saved = localStorage.getItem('gt_shop_list_registry');
          return saved ? JSON.parse(saved) : [];
        });

        const t = useMemo(() => i18n[language], [language]);

        const [shopListName, setShopListName] = useState(localStorage.getItem('gt_shop_list_name') || "");
        
        const [uiSettings, setUiSettings] = useState(() => {
          const saved = localStorage.getItem('gt_ui_settings_v3');
          if (saved) return JSON.parse(saved);
          return {
            gym: { itemHeight: 48, itemWidth: 100, itemSpacing: 12, highlightColor: '#f1f5f9', completedColor: '#ecfdf5', fontSize: 12, lineCount: 2, toastDuration: 3, maxWorkoutTime: 4, enableToasts: true },
            shop: { itemHeight: 40, itemWidth: 95, itemSpacing: 8, highlightColor: '#f1f5f9', completedColor: '#fef2f2', fontSize: 14, lineCount: 1, toastDuration: 3, enableToasts: true }
          };
        });
        const [viewDate, setViewDate] = useState(new Date());
        const [toast, setToast] = useState({ show: false, message: '' });
        const [isLoaded, setIsLoaded] = useState(false);
        const [isStatsOpen, setIsStatsOpen] = useState(false);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [draggedIdx, setDraggedIdx] = useState(null);
        const [isDraggingInProgress, setIsDraggingInProgress] = useState(false);
        const [isClearConfirming, setIsClearConfirming] = useState(false);
        const [isListDeleteConfirming, setIsListDeleteConfirming] = useState(false);
        const clearConfirmTimeout = useRef(null);
        const listDeleteConfirmTimeout = useRef(null);
        const importFileRef = useRef(null);
        
        const [now, setNow] = useState(Date.now());
        const longPressTimer = useRef(null);
        const isLongPressActive = useRef(false);

        const viewDateKey = useMemo(() => getDateKey(viewDate), [viewDate]);

        // –°–æ–≤–º–µ—â–∞–µ–º –º–∞–Ω—É–∞–ª—å–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä —Å —Ç–µ–º, —á—Ç–æ –µ—Å—Ç—å –≤ –∑–∞–ø–∏—Å—è—Ö (–¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)
        const knownExercises = useMemo(() => {
          const fromRecords = new Set(records.filter(r => (r.mode === 'gym' || !r.mode) && r.description.trim() !== '').map(r => r.description.trim()));
          const combined = new Set([...exerciseRegistry, ...fromRecords]);
          return Array.from(combined).sort((a,b) => a.localeCompare(b));
        }, [records, exerciseRegistry]);

        const knownShopItems = useMemo(() => {
          const fromRecords = new Set(records.filter(r => r.mode === 'shop' && r.description.trim() !== '').map(r => r.description.trim()));
          const combined = new Set([...shopRegistry, ...fromRecords]);
          return Array.from(combined).sort((a,b) => a.localeCompare(b));
        }, [records, shopRegistry]);

        // –†–µ–µ—Å—Ç—Ä –∏–º–µ–Ω —Å–ø–∏—Å–∫–æ–≤
        const allShopLists = useMemo(() => {
          const listSet = new Set(shopListRegistry);
          records.forEach(r => {
            if (r.mode === 'shop' && r.listName) {
              listSet.add(r.listName);
            }
          });
          return Array.from(listSet).filter(Boolean).sort((a, b) => a.localeCompare(b));
        }, [records, shopListRegistry]);

        const currentRecords = useMemo(() => {
          if (mode === 'gym') {
            return records.filter(r => r.dateKey === viewDateKey && (r.mode === 'gym' || !r.mode));
          } else {
            const targetName = shopListName || "";
            return records.filter(r => r.mode === 'shop' && (r.listName === targetName));
          }
        }, [records, viewDateKey, mode, shopListName]);

        const currentWeight = weights[viewDateKey] || '';
        const displayDate = viewDate.toLocaleDateString(language === 'ru' ? 'ru-RU' : 'en-US', { day: '2-digit', month: '2-digit', year: '2-digit' });

        const currentSessionDuration = useMemo(() => {
          const sess = sessions[viewDateKey];
          if (!sess || !sess.start) return null;
          const endTime = sess.end || now;
          const diffMs = endTime - sess.start;
          
          const maxHours = uiSettings.gym?.maxWorkoutTime || 4;
          const maxMs = maxHours * 60 * 60 * 1000; 
          const effectiveMs = Math.max(0, Math.min(diffMs, maxMs));
          
          const hours = Math.floor(effectiveMs / 3600000);
          const mins = Math.floor((effectiveMs % 3600000) / 60000);
          const secs = Math.floor((effectiveMs % 60000) / 1000);
          
          return `${hours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }, [sessions, viewDateKey, now, uiSettings.gym?.maxWorkoutTime]);

        useEffect(() => { localStorage.setItem('gt_lang', language); }, [language]);
        useEffect(() => { localStorage.setItem('gt_mode', mode); }, [mode]);
        useEffect(() => { localStorage.setItem('gt_ui_settings_v3', JSON.stringify(uiSettings)); }, [uiSettings]);
        useEffect(() => { localStorage.setItem('gt_shop_list_name', shopListName); }, [shopListName]);
        useEffect(() => { localStorage.setItem('gt_shop_list_registry', JSON.stringify(shopListRegistry)); }, [shopListRegistry]);
        useEffect(() => { localStorage.setItem('gt_exercise_registry', JSON.stringify(exerciseRegistry)); }, [exerciseRegistry]);
        useEffect(() => { localStorage.setItem('gt_shop_registry', JSON.stringify(shopRegistry)); }, [shopRegistry]);

        useEffect(() => {
          const init = async () => {
            try {
              const [savedRecords, savedWeights, savedSessions] = await Promise.all([loadFromDB(), loadWeightsFromDB(), loadSessionsFromDB()]);
              if (savedRecords) {
                const updated = savedRecords.map(r => r.dateKey ? r : { ...r, dateKey: getDateKey(r.createdAt || Date.now()) });
                setRecords(updated);
                
                // –ï—Å–ª–∏ —Ä–µ–µ—Å—Ç—Ä—ã –ø—É—Å—Ç—ã, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞—Å–µ–ª–∏—Ç—å –∏—Ö –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –æ–¥–∏–Ω —Ä–∞–∑
                if (exerciseRegistry.length === 0) {
                   const exFromRec = new Set(updated.filter(r => (r.mode === 'gym' || !r.mode) && r.description.trim()).map(r => r.description.trim()));
                   if (exFromRec.size > 0) setExerciseRegistry(Array.from(exFromRec).sort());
                }
                if (shopRegistry.length === 0) {
                   const shFromRec = new Set(updated.filter(r => r.mode === 'shop' && r.description.trim()).map(r => r.description.trim()));
                   if (shFromRec.size > 0) setShopRegistry(Array.from(shFromRec).sort());
                }
              }
              if (savedWeights) setWeights(savedWeights);
              if (savedSessions) setSessions(savedSessions);
              setIsLoaded(true);
            } catch (err) { setIsLoaded(true); }
          };
          init();
        }, []);

        useEffect(() => {
          if (mode === 'gym') {
            const activeSess = sessions[viewDateKey];
            if (activeSess && activeSess.start && !activeSess.end) {
               const interval = setInterval(() => setNow(Date.now()), 1000);
               return () => clearInterval(interval);
            }
          }
        }, [sessions, viewDateKey, mode]);

        useEffect(() => {
          if (isLoaded && !isDraggingInProgress) { saveToDB(records).catch(console.error); }
        }, [records, isLoaded, isDraggingInProgress]);

        const showToast = (message, force = false) => { 
          const currentSettings = uiSettings[mode];
          // If toasts are disabled and it's not a "forced" message (like errors/saves), don't show
          if (!force && currentSettings.enableToasts === false) return;
          
          setToast({ show: true, message }); 
          const duration = (currentSettings.toastDuration || 3) * 1000;
          setTimeout(() => setToast({ show: false, message: '' }), duration); 
        };
        
        const changeDate = (offset) => { setViewDate(prev => { const n = new Date(prev); n.setDate(n.getDate() + offset); return n; }); };
        
        const changeShopList = (offset) => {
          const lists = allShopLists;
          const currentIndex = lists.indexOf(shopListName);

          if (offset === 1) { // Next
            if (currentIndex === -1) { 
              if (lists.length > 0) setShopListName(lists[0]);
              else setShopListName("");
            } else if (currentIndex === lists.length - 1) {
              setShopListName(""); 
            } else {
              setShopListName(lists[currentIndex + 1]);
            }
          } else { // Prev
            if (currentIndex === -1) { 
              if (lists.length > 0) setShopListName(lists[lists.length - 1]);
              else setShopListName("");
            } else if (currentIndex === 0) {
              setShopListName(""); 
            } else {
              setShopListName(lists[currentIndex - 1]);
            }
          }
        };

        const toggleMode = () => { 
          const newMode = mode === 'gym' ? 'shop' : 'gym'; 
          setMode(newMode); 
        };

        const handleManualSave = async () => { 
          try { 
            if (mode === 'shop' && shopListName.trim() && !shopListRegistry.includes(shopListName.trim())) {
              setShopListRegistry(prev => [...prev, shopListName.trim()]);
            }
            await Promise.all([saveToDB(records), saveWeightToDB(viewDateKey, currentWeight)]); 
            showToast(t.savedToast, true); 
          } catch (err) { 
            showToast(t.errorToast, true); 
          } 
        };

        const handleWeightChange = (val) => { const cleaned = val.replace(/[^0-9.]/g, ''); setWeights(prev => ({ ...prev, [viewDateKey]: cleaned })); saveWeightToDB(viewDateKey, cleaned).catch(console.error); };
        
        const exportJSON = () => { 
          const dataStr = JSON.stringify({ 
            records, weights, uiSettings, mode, sessions, shopListRegistry, 
            exerciseRegistry, shopRegistry, exportedAt: new Date().toISOString() 
          }, null, 2); 
          const blob = new Blob([dataStr], { type: 'application/json' }); 
          const url = URL.createObjectURL(blob); 
          const link = document.createElement('a'); 
          link.href = url; 
          link.download = `tracker-export-${new Date().toISOString().split('T')[0]}.json`; 
          link.click(); 
          URL.revokeObjectURL(url); 
          showToast(t.exportToast, true); 
        };

        const importJSON = (event) => { 
          const file = event.target.files[0]; 
          if (!file) return; 
          const reader = new FileReader(); 
          reader.onload = async (e) => { 
            try { 
              const data = JSON.parse(e.target.result); 
              if (data.records) setRecords(data.records); 
              if (data.weights) setWeights(data.weights); 
              if (data.uiSettings) setUiSettings(data.uiSettings); 
              if (data.mode) setMode(data.mode); 
              if (data.sessions) setSessions(data.sessions); 
              if (data.shopListRegistry) setShopListRegistry(data.shopListRegistry); 
              if (data.exerciseRegistry) setExerciseRegistry(data.exerciseRegistry);
              if (data.shopRegistry) setShopRegistry(data.shopRegistry);

              if (data.records) await saveToDB(data.records); 
              if (data.weights) { for (const [dk, w] of Object.entries(data.weights)) { await saveWeightToDB(dk, w); } } 
              if (data.sessions) { for (const [dk, s] of Object.entries(data.sessions)) { await saveSessionToDB(dk, s); } } 
              showToast(t.importToast, true); 
              event.target.value = ''; 
            } catch (err) { showToast(t.errorToast, true); } 
          }; 
          reader.readAsText(file); 
        };

        const triggerImport = () => { importFileRef.current.click(); };
        
        const addNewRecord = () => { 
          let listNameToUse = shopListName;
          if (mode === 'shop') {
            if (!listNameToUse) {
              listNameToUse = t.defaultListName;
              setShopListName(t.defaultListName);
            }
            if (listNameToUse && !shopListRegistry.includes(listNameToUse)) {
              setShopListRegistry(prev => [...prev, listNameToUse]);
            }
          }

          const newRecord = { 
            id: String(Date.now() + Math.random()), 
            description: '', 
            val1: '', 
            val2: '', 
            val3: '', 
            isNew: true, 
            isHighlighted: false, 
            isCompleted: false, 
            createdAt: Date.now(), 
            dateKey: viewDateKey, 
            mode: mode, 
            listName: mode === 'shop' ? listNameToUse : null, 
            sortOrder: records.length 
          }; 
          setRecords(prev => [...prev, newRecord]); 
        };

        const deleteAllForCurrentContext = () => { 
          if (isClearConfirming) { 
            if (mode === 'gym') {
              setRecords(prev => prev.filter(r => !(r.dateKey === viewDateKey && (r.mode === 'gym' || !r.mode))));
            } else {
              setRecords(prev => prev.filter(r => !(r.mode === 'shop' && r.listName === (shopListName || t.defaultListName))));
            }
            setIsClearConfirming(false); 
            showToast(t.clearedToast, true); 
          } else { 
            setIsClearConfirming(true); 
            if (clearConfirmTimeout.current) clearTimeout(clearConfirmTimeout.current); 
            clearConfirmTimeout.current = setTimeout(() => setIsClearConfirming(false), 3000); 
          } 
        };

        const handleDeleteCurrentShopList = () => {
          if (!shopListName) return;
          if (isListDeleteConfirming) {
            const listToDelete = shopListName;
            setRecords(prev => prev.filter(r => !(r.mode === 'shop' && r.listName === listToDelete)));
            setShopListRegistry(prev => prev.filter(name => name !== listToDelete));
            
            // Switch to another list or reset
            const listsAfterDeletion = allShopLists.filter(l => l !== listToDelete);
            if (listsAfterDeletion.length > 0) {
              setShopListName(listsAfterDeletion[0]);
            } else {
              setShopListName("");
            }
            
            setIsListDeleteConfirming(false);
            showToast(t.listDeletedToast, true);
          } else {
            setIsListDeleteConfirming(true);
            if (listDeleteConfirmTimeout.current) clearTimeout(listDeleteConfirmTimeout.current);
            listDeleteConfirmTimeout.current = setTimeout(() => setIsListDeleteConfirming(false), 3000);
          }
        };

        const clearRegistryOfEmptyLists = () => {
          const usedListNames = new Set(records.filter(r => r.mode === 'shop').map(r => r.listName));
          setShopListRegistry(Array.from(usedListNames).filter(Boolean));
          showToast(t.clearedToast, true);
        };

        const copyFromLastWorkout = () => { 
          if (mode === 'gym') {
            const filteredRecords = records.filter(r => r.mode === 'gym' || !r.mode); 
            const pastDates = [...new Set(filteredRecords.map(r => r.dateKey))].filter(dk => dk < viewDateKey).sort(); 
            const lastDate = pastDates.pop(); 
            if (!lastDate) { showToast(t.noPastData, true); return; } 
            const toCopy = filteredRecords.filter(r => r.dateKey === lastDate); 
            const cloned = toCopy.map((r, i) => ({ ...r, id: String(Date.now() + Math.random() + i), dateKey: viewDateKey, val1: '', val2: '', val3: '', isNew: false, isHighlighted: r.isHighlighted, isCompleted: false, createdAt: Date.now(), mode: 'gym', sortOrder: records.length + i })); 
            setRecords(prev => [...prev, ...cloned]); 
            showToast(`${t.copySuccess} ${lastDate} üìã`, true); 
          } else {
            showToast(t.noPastData, true);
          }
        };

        const updateRecord = (id, field, value) => { setRecords(prev => prev.map(r => r.id === id ? { ...r, [field]: value } : r)); };
        const deleteRecord = (id) => { setRecords(prev => prev.filter(r => r.id !== id)); };
        
        const handleStartSession = () => {
           const currentSess = sessions[viewDateKey];
           let newStart = Date.now();
           
           if (!currentSess || !currentSess.start) {
             // –ß–∏—Å—Ç—ã–π –∑–∞–ø—É—Å–∫
             newStart = Date.now();
           } else if (currentSess.end) {
             // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–∞—É–∑—ã
             const elapsed = currentSess.end - currentSess.start;
             newStart = Date.now() - elapsed;
           } else {
             // –£–∂–µ –∑–∞–ø—É—â–µ–Ω–æ - –Ω–µ –º–µ–Ω—è–µ–º
             return;
           }

           const newSess = { start: newStart, end: null };
           setSessions(prev => ({ ...prev, [viewDateKey]: newSess }));
           saveSessionToDB(viewDateKey, newSess).catch(console.error);
           setNow(Date.now());
        };

        const handleResetSession = () => {
           const newSess = { start: null, end: null };
           setSessions(prev => ({ ...prev, [viewDateKey]: newSess }));
           saveSessionToDB(viewDateKey, newSess).catch(console.error);
           // Show "Time reset" toast - informational
           showToast(t.resetToast);
           if (window.navigator.vibrate) window.navigator.vibrate(50);
        };

        const handleFinishSession = () => {
           const currentSess = sessions[viewDateKey];
           if (!currentSess || !currentSess.start || currentSess.end) return;
           const newSess = { ...currentSess, end: Date.now() };
           setSessions(prev => ({ ...prev, [viewDateKey]: newSess }));
           saveSessionToDB(viewDateKey, newSess).catch(console.error);
           setNow(Date.now());
        };

        const onStartPointerDown = () => {
          isLongPressActive.current = false;
          longPressTimer.current = setTimeout(() => {
            isLongPressActive.current = true;
            handleResetSession();
          }, 600);
        };

        const onStartPointerUp = () => {
          clearTimeout(longPressTimer.current);
          if (!isLongPressActive.current) {
            handleStartSession();
          }
        };

        const handleDragStart = (e, index) => { 
          setDraggedIdx(index); 
          setIsDraggingInProgress(true); 
        };

        const handleDragOver = (e, index) => { 
          e.preventDefault(); 
          if (draggedIdx === null || draggedIdx === index) return; 
          
          const itemMoving = currentRecords[draggedIdx]; 
          const targetItem = currentRecords[index]; 
          
          setRecords(prev => { 
            const next = [...prev]; 
            const idxM = next.findIndex(r => r.id === itemMoving.id); 
            const idxT = next.findIndex(r => r.id === targetItem.id); 
            
            if (idxM === -1 || idxT === -1) return prev; 
            
            const [removed] = next.splice(idxM, 1); 
            next.splice(idxT, 0, removed); 
            
            // –í–∞–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å sortOrder –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫
            return next.map((r, i) => ({ ...r, sortOrder: i }));
          }); 
          
          setDraggedIdx(index); 
        };

        const handleDragEnd = () => { 
          setDraggedIdx(null); 
          setIsDraggingInProgress(false); 
        };

        if (!isLoaded) return null;

        const sessionStartActive = !!sessions[viewDateKey]?.start && !sessions[viewDateKey]?.end;
        const sessionPaused = !!sessions[viewDateKey]?.start && !!sessions[viewDateKey]?.end;

        return (
          <div className="min-h-screen max-w-md mx-auto flex flex-col relative pb-10">
            <div className={`toast ${toast.show ? 'show' : ''}`}>{toast.message}</div>
            <StatsModal isOpen={isStatsOpen} onClose={() => setIsStatsOpen(false)} weights={weights} records={records} knownExercises={knownExercises} t={t} />
            <SettingsModal 
                isOpen={isSettingsOpen} 
                onClose={() => setIsSettingsOpen(false)} 
                language={language} 
                setLanguage={setLanguage} 
                uiSettings={uiSettings} 
                setUiSettings={setUiSettings} 
                activeMode={mode} 
                exerciseRegistry={exerciseRegistry}
                setExerciseRegistry={setExerciseRegistry}
                shopRegistry={shopRegistry}
                setShopRegistry={setShopRegistry}
                clearRegistry={clearRegistryOfEmptyLists}
                t={t} 
            />

            <header className="px-4 pt-3 pb-1 sticky top-0 bg-slate-50/95 backdrop-blur-md z-40 border-b border-slate-100">
              <div className="flex justify-between items-center mb-1.5 px-2">
                <h1 onClick={toggleMode} className="text-[17px] font-black text-slate-900 tracking-tight mode-toggle hover:scale-105 active:scale-95 transition-transform">{mode === 'gym' ? t.appName : t.shopName}</h1>
                {mode === 'gym' && (
                  <div className="flex items-center gap-1 bg-slate-200/50 rounded-lg px-2 py-0.5">
                    <span className="text-[9px] font-bold text-slate-500 uppercase tracking-tighter">{t.weight}</span>
                    <input type="text" inputMode="decimal" value={currentWeight} onChange={(e) => handleWeightChange(e.target.value)} placeholder="--" className="w-10 bg-transparent border-none text-center text-sm font-black text-slate-900 focus:outline-none placeholder:text-slate-400" />
                    <span className="text-[9px] font-bold text-slate-400">{t.kg}</span>
                  </div>
                )}
                <div className="flex items-center gap-2">
                  {mode === 'gym' && (<button onClick={() => setIsStatsOpen(true)} className="p-1 text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.stats}><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg></button>)}
                  <button onClick={() => setIsSettingsOpen(true)} className="p-1 text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.settings}><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button>
                  <input type="file" ref={importFileRef} onChange={importJSON} accept=".json" className="hidden" />
                  <button onClick={triggerImport} className="p-1 text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.import}><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v8" /></svg></button>
                  <button onClick={exportJSON} className="p-1 text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.export}><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M8 8l4 4m0 0l4-4m-4 4V4" /></svg></button>
                  <button onClick={handleManualSave} className="p-1 text-slate-900 hover:text-slate-900 active:scale-125 transition-transform" title={t.save}><svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
                </div>
              </div>
              
              <div className="flex items-center justify-between bg-white/60 rounded-xl p-0.5 border border-slate-200/50 shadow-sm min-h-[44px]">
                {mode === 'gym' ? (
                  <React.Fragment>
                    <div className="w-10 flex justify-center">
                      <button onClick={() => changeDate(-1)} className="nav-btn shrink-0"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M15 19l-7-7 7-7" /></svg></button>
                    </div>
                    
                    <div className="flex-1 flex justify-center">
                      <button 
                        onPointerDown={onStartPointerDown}
                        onPointerUp={onStartPointerUp}
                        onPointerLeave={() => clearTimeout(longPressTimer.current)}
                        onContextMenu={(e) => e.preventDefault()}
                        className={`px-3 py-1 text-[9px] font-black uppercase tracking-tighter rounded-md transition-all duration-300 select-none ${sessionStartActive ? 'bg-emerald-600 text-white shadow-md' : sessionPaused ? 'bg-amber-500 text-white' : 'bg-slate-100 text-slate-600 active:bg-slate-900 active:text-white'}`}
                      >
                        {sessionPaused ? t.start : t.start}
                      </button>
                    </div>

                    <div onClick={() => setViewDate(new Date())} className="flex flex-col items-center justify-center cursor-pointer px-1 shrink-0 min-w-[90px]">
                      <span className="text-[10px] font-black text-slate-900 tabular-nums leading-none whitespace-nowrap mb-0.5">{displayDate}</span>
                      {currentSessionDuration && (
                        <div className="flex flex-col items-center gap-0">
                          <span className="text-[7px] font-black text-slate-400 uppercase tracking-widest leading-none mb-0.5">{t.workoutTime}</span>
                          <span className={`text-[11px] font-black tabular-nums leading-none ${sessionPaused ? 'text-slate-400' : 'text-slate-600'}`}>
                            {currentSessionDuration}
                          </span>
                        </div>
                      )}
                    </div>

                    <div className="flex-1 flex justify-center">
                      <button 
                        onClick={handleFinishSession} 
                        className={`px-3 py-1 text-[9px] font-black uppercase tracking-tighter rounded-md transition-all duration-300 ${sessionPaused ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-600 active:bg-slate-900 active:text-white'}`}
                      >
                        {t.finish}
                      </button>
                    </div>

                    <div className="w-10 flex justify-center">
                      <button onClick={() => changeDate(1)} className="nav-btn shrink-0"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M9 5l7 7-7 7" /></svg></button>
                    </div>
                  </React.Fragment>
                ) : (
                  <React.Fragment>
                    <button onClick={() => changeShopList(-1)} className="nav-btn shrink-0"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M15 19l-7-7 7-7" /></svg></button>
                    
                    <div className="flex items-center flex-1 px-1 gap-1.5 min-w-0 transition-all">
                      <div className="shrink-0">
                        <svg className="w-3.5 h-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2" /></svg>
                      </div>
                      <input 
                        type="text" 
                        value={shopListName} 
                        onChange={(e) => setShopListName(e.target.value)} 
                        placeholder={t.defaultListName}
                        className={`flex-1 bg-transparent border-none outline-none text-sm font-black focus:ring-0 p-0 m-0 overflow-hidden text-ellipsis whitespace-nowrap transition-colors ${shopListRegistry.includes(shopListName.trim()) ? 'text-slate-900' : 'text-slate-400'}`}
                      />
                    </div>

                    <button onClick={() => changeShopList(1)} className="nav-btn shrink-0"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M9 5l7 7-7 7" /></svg></button>
                    
                    {/* Delete Current List Button */}
                    <button 
                      onClick={handleDeleteCurrentShopList} 
                      className={`nav-btn shrink-0 w-8 h-8 flex items-center justify-center transition-all duration-300 ${isListDeleteConfirming ? 'text-red-600 bg-red-50 rounded-lg scale-110' : 'text-slate-400'}`}
                      title={t.deleteListConfirm}
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {isListDeleteConfirming ? (
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12" />
                        ) : (
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        )}
                      </svg>
                    </button>
                  </React.Fragment>
                )}
              </div>
            </header>

            <main className="px-4 pb-12 pt-1.5 flex flex-col items-start">
              <div className="w-full">
                {currentRecords.map((r, idx) => (
                    <TrackerItem 
                        key={r.id} 
                        record={r} 
                        index={idx} 
                        onDelete={deleteRecord} 
                        onUpdate={updateRecord} 
                        onDragStart={handleDragStart} 
                        onDragOver={handleDragOver} 
                        onDragEnd={handleDragEnd} 
                        isDragging={draggedIdx === idx} 
                        uiSettings={uiSettings[mode]} 
                        mode={mode} 
                        knownItems={mode === 'gym' ? knownExercises : knownShopItems}
                        t={t} 
                    />
                ))}
              </div>
              <div className="flex flex-col gap-3 mt-1.5 ml-1 w-full pr-1">
                {currentRecords.length === 0 && mode === 'gym' && (
                  <button onClick={copyFromLastWorkout} className="action-button w-full h-11 bg-slate-900 text-white rounded-xl flex items-center justify-center gap-2 shadow-lg mb-0.5">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                    <span className="text-sm font-bold">{t.repeatLast}</span>
                  </button>
                )}
                
                <button onClick={addNewRecord} className="action-button w-full h-11 bg-slate-900 text-white rounded-xl flex items-center justify-center gap-2 shadow-lg">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M12 6v12m6-6H6" /></svg>
                  <span className="text-sm font-bold">{mode === 'gym' ? t.addExercise : t.addItem}</span>
                </button>
                
                {currentRecords.length > 0 && (
                  <button onClick={deleteAllForCurrentContext} className={`action-button w-full h-11 rounded-xl flex items-center justify-center gap-2 shadow-md transition-all ${isClearConfirming ? 'bg-red-500 text-white scale-[1.02]' : 'bg-white text-slate-400 border border-slate-200'}`}><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">{isClearConfirming ? (<path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12" />) : (<path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />)}</svg><span className="text-xs font-bold uppercase tracking-wider">{isClearConfirming ? t.clearConfirm : t.clearBtn}</span></button>
                )}
              </div>
            </main>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
