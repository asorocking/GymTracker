
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#4f46e5" />
    <title>Quick Tracker</title>
    
    <!-- Библиотеки (UMD версии — создают глобальные переменные React и ReactDOM) -->
    <script src="https://unpkg.com/react@18.3.1/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.10/babel.min.js"></script>

    <style>
      #root:empty::before {
        content: "";
        display: block;
        width: 40px;
        height: 40px;
        margin: 45vh auto 0;
        border: 4px solid #e2e8f0;
        border-top-color: #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      
      /* Отладчик на случай падения */
      #error-display {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0;
        background: #fee2e2;
        color: #991b1b;
        padding: 1rem;
        font-family: monospace;
        font-size: 12px;
        z-index: 9999;
        white-space: pre-wrap;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
  <body class="bg-slate-50 antialiased">
    <div id="error-display"></div>
    <div id="root"></div>

    <script>
      // Перехват глобальных ошибок для отладки
      window.onerror = function(msg, url, line) {
        const display = document.getElementById('error-display');
        display.style.display = 'block';
        display.textContent += `Error: ${msg}\nLine: ${line}\nUrl: ${url}\n\n`;
      };
    </script>

    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect } = React;

      // --- UI Components ---
      const TrackerItem = ({ record, onDelete, onEdit, onValueChange }) => (
        <div className="bg-white border border-slate-200 rounded-2xl p-4 flex items-center justify-between shadow-sm active:scale-[0.98] transition-all">
          <div className="flex-1 cursor-pointer pr-4" onClick={() => onEdit(record)}>
            <div className="text-sm font-black text-slate-800 uppercase tracking-tight truncate leading-tight">
              {record.line1 || 'Без названия'}
            </div>
            <div className="text-[11px] text-slate-400 font-medium truncate mt-1 uppercase tracking-wider">
              {record.line2 || 'Нет описания'}
            </div>
          </div>

          <div className="flex items-center gap-2 shrink-0">
            {['val1', 'val2', 'val3'].map((f) => (
              <input 
                key={f}
                type="text" 
                inputMode="numeric"
                value={record[f] || ''}
                onChange={(e) => onValueChange(record.id, f, e.target.value.slice(0, 2))}
                className="w-11 h-11 text-center border-2 border-slate-100 rounded-xl text-sm font-black focus:border-indigo-500 focus:outline-none bg-slate-50 text-indigo-600"
                placeholder="0"
                onClick={(e) => e.stopPropagation()}
              />
            ))}
          </div>

          <button onClick={(e) => { e.stopPropagation(); onDelete(record.id); }} className="ml-4 text-slate-300 hover:text-red-500">
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      );

      const Modal = ({ onClose, onSubmit, data }) => {
        const [form, setForm] = useState({
          line1: data?.line1 || '',
          line2: data?.line2 || '',
          val1: data?.val1 || '',
          val2: data?.val2 || '',
          val3: data?.val3 || '',
        });

        return (
          <div className="fixed inset-0 bg-slate-900/80 flex items-end sm:items-center justify-center z-50 p-0 sm:p-4 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 shadow-2xl animate-in slide-in-from-bottom duration-300">
              <div className="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8 sm:hidden" onClick={onClose}></div>
              <h2 className="text-2xl font-black text-slate-900 mb-8 tracking-tighter">
                {data ? 'РЕДАКТИРОВАТЬ' : 'НОВАЯ ЗАПИСЬ'}
              </h2>
              <div className="space-y-6">
                <div className="space-y-1">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Заголовок</label>
                  <input 
                    autoFocus
                    className="w-full bg-slate-50 border-2 border-transparent focus:border-indigo-500 rounded-2xl p-4 text-base font-bold outline-none transition-all"
                    placeholder="Например: Тренировка"
                    value={form.line1}
                    onChange={e => setForm({...form, line1: e.target.value})}
                  />
                </div>
                <div className="space-y-1">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Описание</label>
                  <input 
                    className="w-full bg-slate-50 border-2 border-transparent focus:border-indigo-500 rounded-2xl p-4 text-base font-bold outline-none transition-all"
                    placeholder="Детали..."
                    value={form.line2}
                    onChange={e => setForm({...form, line2: e.target.value})}
                  />
                </div>
                <div className="flex gap-4 pt-4">
                  <button onClick={onClose} className="flex-1 py-4 text-slate-400 font-black text-sm tracking-widest uppercase">Отмена</button>
                  <button onClick={() => onSubmit(form)} className="flex-1 py-4 bg-indigo-600 text-white rounded-3xl font-black shadow-xl shadow-indigo-200 active:scale-95 transition-all text-sm tracking-widest uppercase">
                    Сохранить
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const App = () => {
        const [records, setRecords] = useState(() => {
          try {
            const saved = localStorage.getItem('tracker_v5_prod');
            return saved ? JSON.parse(saved) : [];
          } catch(e) { return []; }
        });
        const [modal, setModal] = useState({ open: false });

        useEffect(() => {
          localStorage.setItem('tracker_v5_prod', JSON.stringify(records));
        }, [records]);

        const handleSave = (formData) => {
          if (modal.data) {
            setRecords(prev => prev.map(r => r.id === modal.data.id ? { ...r, ...formData } : r));
          } else {
            setRecords(prev => [{ ...formData, id: Date.now().toString() }, ...prev]);
          }
          setModal({ open: false });
        };

        return (
          <div className="min-h-screen max-w-md mx-auto flex flex-col relative bg-slate-50 overflow-x-hidden">
            <header className="p-8 pb-4">
              <div className="flex justify-between items-start">
                <div>
                  <h1 className="text-4xl font-black text-slate-900 tracking-tighter leading-none">GO!</h1>
                  <p className="text-[10px] font-black text-indigo-500 uppercase tracking-[0.3em] mt-2">Personal Tracker</p>
                </div>
                <div className="bg-indigo-100 px-3 py-1 rounded-full">
                   <span className="text-[10px] font-black text-indigo-600">{records.length} ITEMS</span>
                </div>
              </div>
            </header>

            <main className="flex-1 p-6 space-y-4 pb-32">
              {records.map(r => (
                <TrackerItem 
                  key={r.id} record={r} 
                  onDelete={id => { if(confirm('Удалить?')) setRecords(prev => prev.filter(x => x.id !== id)) }}
                  onEdit={data => setModal({ open: true, data })}
                  onValueChange={(id, f, v) => setRecords(prev => prev.map(r => r.id === id ? {...r, [f]: v} : r))}
                />
              ))}
              {records.length === 0 && (
                <div className="py-20 text-center opacity-20">
                  <div className="w-16 h-16 border-4 border-dashed border-slate-900 rounded-full mx-auto mb-4"></div>
                  <p className="font-black text-xs uppercase tracking-widest">Список пуст</p>
                </div>
              )}
            </main>

            <div className="fixed bottom-10 left-0 right-0 flex justify-center pointer-events-none">
              <button 
                onClick={() => setModal({ open: true })}
                className="w-16 h-16 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center active:scale-90 transition-all pointer-events-auto"
              >
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M12 6v12m6-6H6" />
                </svg>
              </button>
            </div>

            {modal.open && <Modal data={modal.data} onClose={() => setModal({ open: false })} onSubmit={handleSave} />}
          </div>
        );
      };

      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
      console.log("App rendered successfully");
    </script>

    <script>
      // Service Worker с форсированной очисткой кэша
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(reg => {
            console.log('SW Registered');
          }).catch(console.error);
        });
      }
    </script>
  </body>
</html>
