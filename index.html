
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#f8fafc" />
    
    <!-- Favicon & Icons -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3163/3163181.png" />
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3163/3163181.png" />
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="GymTracker" />
    
    <title>GymTracker Pro</title>
    
    <script src="https://unpkg.com/react@18.3.1/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.10/babel.min.js"></script>
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      #root:empty::before {
        content: "";
        display: block;
        width: 24px;
        height: 24px;
        margin: 45vh auto 0;
        border: 2px solid #e2e8f0;
        border-top-color: #0f172a;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      
      body {
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: contain;
        background-color: #f8fafc;
        height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      
      .fade-in {
        animation: fadeIn 0.2s ease-out forwards;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .tracker-item {
        min-height: 36px;
        transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      }
      
      .tracker-item.dragging {
        opacity: 0.4;
        transform: scale(0.98);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      }

      .drag-handle {
        cursor: grab;
        touch-action: none;
      }
      .drag-handle:active {
        cursor: grabbing;
      }
      
      textarea {
        resize: none !important;
        overflow: hidden;
        line-height: 1.1;
        appearance: none;
        -webkit-appearance: none;
      }

      .delete-btn-active {
        color: #ef4444 !important;
        background-color: #fef2f2;
        border-radius: 6px;
      }

      .action-button {
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
      }
      .action-button:active {
        transform: scale(0.92);
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
      }

      .secondary-button {
        transition: all 0.2s ease;
        @apply flex items-center justify-center gap-2 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider border border-slate-200 bg-white text-slate-600 shadow-sm active:scale-95;
      }

      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
        padding: 12px 20px;
        border-radius: 99px;
        background: #0f172a;
        color: white;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        pointer-events: none;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .toast.show {
        opacity: 1;
        top: 30px;
      }

      .nav-btn {
        @apply p-1 text-slate-500 hover:text-slate-900 transition-all active:scale-125;
      }

      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .modal-backdrop {
        background: rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
    </style>
  </head>
  <body class="antialiased text-slate-900">
    <div id="root"></div>

    <script>
      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered'))
            .catch(err => console.log('SW error', err));
        });
      }
    </script>

    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect, useRef, useMemo } = React;

      // Localization
      const i18n = {
        ru: {
          appName: "GymTracker",
          weight: "Ð’ÐµÑ",
          kg: "ÐºÐ³",
          stats: "Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°",
          export: "Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚",
          save: "Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ",
          progress: "ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ Ð²ÐµÑÐ°",
          noData: "ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ…",
          close: "Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ",
          recordPlaceholder: "Ð—Ð°Ð¿Ð¸ÑÑŒ...",
          savedToast: "Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾ ðŸ’¾",
          errorToast: "ÐžÑˆÐ¸Ð±ÐºÐ° âš ï¸",
          exportToast: "Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ ðŸ“¤",
          addExercise: "Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ",
          repeatLast: "ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÑˆÐ»ÑƒÑŽ",
          noPastData: "ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… ðŸ¤·â€â™‚ï¸",
          copySuccess: "ÐšÐ¾Ð¿Ð¸Ñ:",
          clearConfirm: "ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ?",
          clearBtn: "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð·Ð° Ð´ÐµÐ½ÑŒ",
          clearedToast: "ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð¾ ðŸ—‘ï¸",
          settings: "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸",
          language: "Ð¯Ð·Ñ‹Ðº",
          russian: "Ð ÑƒÑÑÐºÐ¸Ð¹",
          english: "English"
        },
        en: {
          appName: "GymTracker",
          weight: "Weight",
          kg: "kg",
          stats: "Stats",
          export: "Export",
          save: "Save",
          progress: "Weight Progress",
          noData: "Not enough data",
          close: "Close",
          recordPlaceholder: "Record...",
          savedToast: "Saved ðŸ’¾",
          errorToast: "Error âš ï¸",
          exportToast: "Exported ðŸ“¤",
          addExercise: "Add Exercise",
          repeatLast: "Repeat previous",
          noPastData: "No data ðŸ¤·â€â™‚ï¸",
          copySuccess: "Copied:",
          clearConfirm: "Confirm clear?",
          clearBtn: "Clear day records",
          clearedToast: "Cleared ðŸ—‘ï¸",
          settings: "Settings",
          language: "Language",
          russian: "Russian",
          english: "English"
        }
      };

      // IndexedDB Constants
      const DB_NAME = 'TrackerDB';
      const STORE_RECORDS = 'records';
      const STORE_WEIGHTS = 'weights';
      const DB_VERSION = 3;

      const initDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_RECORDS)) {
              db.createObjectStore(STORE_RECORDS, { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains(STORE_WEIGHTS)) {
              db.createObjectStore(STORE_WEIGHTS, { keyPath: 'dateKey' });
            }
          };
          request.onsuccess = (e) => resolve(e.target.result);
          request.onerror = (e) => reject(e.target.error);
        });
      };

      const saveToDB = async (records) => {
        if (!records) return;
        const db = await initDB();
        const tx = db.transaction(STORE_RECORDS, 'readwrite');
        const store = tx.objectStore(STORE_RECORDS);
        
        return new Promise((resolve, reject) => {
          const clearReq = store.clear();
          clearReq.onsuccess = () => {
            if (records.length === 0) {
              resolve();
              return;
            }
            records.forEach((r, index) => {
              store.put({ ...r, sortOrder: index });
            });
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
          };
          clearReq.onerror = () => reject(clearReq.error);
        });
      };

      const loadFromDB = async () => {
        const db = await initDB();
        const tx = db.transaction(STORE_RECORDS, 'readonly');
        const store = tx.objectStore(STORE_RECORDS);
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => {
            const results = request.result || [];
            const sorted = results.sort((a, b) => (a.sortOrder ?? 0) - (b.sortOrder ?? 0));
            resolve(sorted);
          };
        });
      };

      const saveWeightToDB = async (dateKey, weight) => {
        const db = await initDB();
        const tx = db.transaction(STORE_WEIGHTS, 'readwrite');
        const store = tx.objectStore(STORE_WEIGHTS);
        return new Promise((resolve, reject) => {
          store.put({ dateKey, weight });
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      };

      const loadWeightsFromDB = async () => {
        const db = await initDB();
        const tx = db.transaction(STORE_WEIGHTS, 'readonly');
        const store = tx.objectStore(STORE_WEIGHTS);
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => {
            const weightsMap = {};
            request.result.forEach(item => { weightsMap[item.dateKey] = item.weight; });
            resolve(weightsMap);
          };
        });
      };

      const getDateKey = (date) => {
        const d = new Date(date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      };

      const SettingsModal = ({ isOpen, onClose, language, setLanguage, t }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 modal-backdrop fade-in">
            <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden flex flex-col">
              <div className="px-6 pt-6 pb-2 flex justify-between items-center border-b border-slate-50">
                <h2 className="text-xl font-black text-slate-900 tracking-tight">{t.settings}</h2>
                <button onClick={onClose} className="p-2 -mr-2 text-slate-400">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div className="p-6 flex flex-col gap-6">
                <div>
                  <label className="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3">{t.language}</label>
                  <div className="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-xl">
                    <button 
                      onClick={() => setLanguage('ru')}
                      className={`py-2 rounded-lg text-xs font-bold transition-all ${language === 'ru' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}
                    >
                      {t.russian}
                    </button>
                    <button 
                      onClick={() => setLanguage('en')}
                      className={`py-2 rounded-lg text-xs font-bold transition-all ${language === 'en' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}
                    >
                      {t.english}
                    </button>
                  </div>
                </div>
              </div>
              <div className="px-6 pb-6 pt-2">
                <button onClick={onClose} className="w-full py-3 bg-slate-900 text-white font-bold rounded-xl active:scale-95">{t.close}</button>
              </div>
            </div>
          </div>
        );
      };

      const StatsModal = ({ isOpen, onClose, weights, t }) => {
        const canvasRef = useRef(null);
        const chartInstance = useRef(null);

        useEffect(() => {
          if (isOpen && canvasRef.current) {
            const sortedEntries = Object.entries(weights)
              .filter(([_, val]) => val !== '' && val !== null)
              .sort((a, b) => new Date(a[0]) - new Date(b[0]));

            if (sortedEntries.length === 0) return;

            const labels = sortedEntries.map(([date]) => {
              const d = new Date(date);
              return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
            });
            const data = sortedEntries.map(([_, val]) => parseFloat(val));

            if (chartInstance.current) { chartInstance.current.destroy(); }

            const ctx = canvasRef.current.getContext('2d');
            chartInstance.current = new Chart(ctx, {
              type: 'line',
              data: {
                labels,
                datasets: [{
                  label: t.weight,
                  data,
                  borderColor: '#0f172a',
                  backgroundColor: 'rgba(15, 23, 42, 0.05)',
                  borderWidth: 3,
                  tension: 0.4,
                  fill: true,
                  pointBackgroundColor: '#0f172a',
                  pointRadius: 4,
                  pointHoverRadius: 6
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                  y: { beginAtZero: false, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } },
                  x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                }
              }
            });
          }
        }, [isOpen, weights, t]);

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-backdrop fade-in">
            <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
              <div className="px-6 pt-6 pb-2 flex justify-between items-center border-b border-slate-50">
                <h2 className="text-xl font-black text-slate-900 tracking-tight">{t.progress}</h2>
                <button onClick={onClose} className="p-2 -mr-2 text-slate-400">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div className="p-6 flex-1 min-h-[300px]">
                {Object.keys(weights).filter(k => weights[k] !== '' && weights[k] !== null).length > 0 ? (
                  <canvas ref={canvasRef}></canvas>
                ) : (
                  <div className="h-full flex flex-col items-center justify-center text-slate-300 gap-4">
                    <p className="text-sm font-bold uppercase tracking-widest text-center">{t.noData}</p>
                  </div>
                )}
              </div>
              <div className="px-6 pb-6 pt-2">
                <button onClick={onClose} className="w-full py-3 bg-slate-100 text-slate-900 font-bold rounded-xl active:scale-95">{t.close}</button>
              </div>
            </div>
          </div>
        );
      };

      const TrackerItem = ({ 
        record, 
        index, 
        onDelete, 
        onUpdate, 
        onDragStart, 
        onDragOver, 
        onDragEnd,
        isDragging,
        t
      }) => {
        const [isConfirming, setIsConfirming] = useState(false);
        const textRef = useRef(null);
        const confirmTimeout = useRef(null);

        useEffect(() => {
          if (record.isNew && textRef.current) {
            textRef.current.focus();
            onUpdate(record.id, 'isNew', false);
          }
        }, []);

        const handleDeleteClick = (e) => {
          e.preventDefault();
          if (isConfirming) {
            onDelete(record.id);
          } else {
            setIsConfirming(true);
            if (confirmTimeout.current) clearTimeout(confirmTimeout.current);
            confirmTimeout.current = setTimeout(() => setIsConfirming(false), 3000);
          }
        };

        const getBgColor = () => {
          if (record.isCompleted && record.isHighlighted) return 'bg-emerald-200 border-emerald-400 ring-1 ring-emerald-400';
          if (record.isCompleted) return 'bg-emerald-50 border-emerald-200 ring-1 ring-emerald-200';
          if (record.isHighlighted) return 'bg-slate-100 border-slate-300 ring-1 ring-slate-300';
          return 'bg-white';
        };

        return (
          <div 
            draggable="true"
            onDragStart={(e) => onDragStart(e, index)}
            onDragOver={(e) => onDragOver(e, index)}
            onDragEnd={onDragEnd}
            className={`border border-slate-200 rounded-lg pl-0.5 pr-0.5 flex items-center shadow-sm fade-in mb-3 tracker-item transition-all duration-200 ${isDragging ? 'dragging' : ''} ${getBgColor()}`}
          >
            
            <div className="flex items-center drag-handle px-0.5 shrink-0">
              <div className="flex flex-col gap-0.5 opacity-20">
                {[1, 2, 3].map(i => (
                  <div key={i} className="flex gap-0.5">
                    <div className="w-0.5 h-0.5 bg-slate-900 rounded-full"></div>
                    <div className="w-0.5 h-0.5 bg-slate-900 rounded-full"></div>
                  </div>
                ))}
              </div>
            </div>

            <div className="flex flex-col items-center gap-0.5 shrink-0 px-0.5 py-0.5">
              <button 
                onClick={() => onUpdate(record.id, 'isHighlighted', !record.isHighlighted)}
                className={`p-0.5 transition-all active:scale-90 ${record.isHighlighted ? 'text-slate-700' : 'text-slate-300'}`}
              >
                <svg className="w-3 h-3" fill={record.isHighlighted ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="9" strokeWidth="4" />
                </svg>
              </button>
              <button 
                onClick={() => onUpdate(record.id, 'isCompleted', !record.isCompleted)}
                className={`p-0.5 transition-all active:scale-90 ${record.isCompleted ? 'text-emerald-600' : 'text-slate-300'}`}
              >
                <svg className="w-3 h-3" fill={record.isCompleted ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={6} d="M5 13l4 4L19 7" />
                </svg>
              </button>
            </div>

            <div className="flex-1 min-w-0 py-0.5 ml-1">
              <textarea 
                ref={textRef}
                rows="2"
                value={record.description}
                onChange={(e) => onUpdate(record.id, 'description', e.target.value)}
                placeholder={t.recordPlaceholder}
                className={`text-[12px] font-semibold bg-transparent border-none outline-none focus:ring-0 placeholder:text-slate-300 w-full p-0 m-0 leading-tight ${record.isHighlighted || record.isCompleted ? 'text-black' : 'text-slate-700'}`}
              />
            </div>

            <div className="flex items-center gap-0.5 shrink-0 px-0.5">
              {['val1', 'val2', 'val3'].map((f) => (
                <input 
                  key={f}
                  type="text" 
                  inputMode="numeric"
                  value={record[f] || ''}
                  onChange={(e) => onUpdate(record.id, f, e.target.value.replace(/\D/g, '').slice(0, 2))}
                  className={`w-6 h-6 text-center border border-slate-100 rounded-md text-[11px] font-bold focus:outline-none focus:border-slate-400 bg-slate-50 shadow-inner p-0 ${record.isHighlighted || record.isCompleted ? 'text-black' : 'text-slate-900'}`}
                  placeholder="0"
                />
              ))}
            </div>

            <button 
              onClick={handleDeleteClick}
              className={`w-7 h-7 shrink-0 flex items-center justify-center transition-all ${isConfirming ? 'delete-btn-active' : 'text-slate-900'}`}
            >
              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        );
      };

      const App = () => {
        const [records, setRecords] = useState([]);
        const [weights, setWeights] = useState({});
        const [language, setLanguage] = useState(localStorage.getItem('gt_lang') || 'ru');
        const [viewDate, setViewDate] = useState(new Date());
        const [toast, setToast] = useState({ show: false, message: '' });
        const [isLoaded, setIsLoaded] = useState(false);
        const [isStatsOpen, setIsStatsOpen] = useState(false);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [draggedIdx, setDraggedIdx] = useState(null);
        const [isDraggingInProgress, setIsDraggingInProgress] = useState(false);
        const [isClearConfirming, setIsClearConfirming] = useState(false);
        const clearConfirmTimeout = useRef(null);

        const t = useMemo(() => i18n[language], [language]);

        const viewDateKey = useMemo(() => getDateKey(viewDate), [viewDate]);
        const currentRecords = useMemo(() => records.filter(r => r.dateKey === viewDateKey), [records, viewDateKey]);
        const currentWeight = weights[viewDateKey] || '';

        const displayDate = viewDate.toLocaleDateString(language === 'ru' ? 'ru-RU' : 'en-US', { day: '2-digit', month: '2-digit', year: '2-digit' });

        useEffect(() => {
          localStorage.setItem('gt_lang', language);
        }, [language]);

        useEffect(() => {
          const init = async () => {
            try {
              const [savedRecords, savedWeights] = await Promise.all([loadFromDB(), loadWeightsFromDB()]);
              if (savedRecords) {
                const updated = savedRecords.map(r => r.dateKey ? r : { ...r, dateKey: getDateKey(r.createdAt || Date.now()) });
                setRecords(updated);
              }
              if (savedWeights) setWeights(savedWeights);
              setIsLoaded(true);
            } catch (err) { setIsLoaded(true); }
          };
          init();
        }, []);

        useEffect(() => {
          if (isLoaded && !isDraggingInProgress) {
            saveToDB(records).catch(console.error);
          }
        }, [records, isLoaded, isDraggingInProgress]);

        const showToast = (message) => {
          setToast({ show: true, message });
          setTimeout(() => setToast({ show: false, message: '' }), 3000);
        };

        const changeDate = (offset) => { setViewDate(prev => { const n = new Date(prev); n.setDate(n.getDate() + offset); return n; }); };

        const handleManualSave = async () => {
          try {
            await Promise.all([saveToDB(records), saveWeightToDB(viewDateKey, currentWeight)]);
            showToast(t.savedToast);
          } catch (err) { showToast(t.errorToast); }
        };

        const handleWeightChange = (val) => {
          const cleaned = val.replace(/[^0-9.]/g, '');
          setWeights(prev => ({ ...prev, [viewDateKey]: cleaned }));
          saveWeightToDB(viewDateKey, cleaned).catch(console.error);
        };

        const exportJSON = () => {
          const dataStr = JSON.stringify({ records, weights, exportedAt: new Date().toISOString() }, null, 2);
          const blob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `gym-export-${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          URL.revokeObjectURL(url);
          showToast(t.exportToast);
        };

        const addNewRecord = () => {
          const newRecord = {
            id: String(Date.now() + Math.random()),
            description: '',
            val1: '', val2: '', val3: '',
            isNew: true,
            isHighlighted: false,
            isCompleted: false,
            createdAt: Date.now(),
            dateKey: viewDateKey,
            sortOrder: records.length
          };
          setRecords(prev => [...prev, newRecord]);
        };

        const deleteAllForCurrentDay = () => {
          if (isClearConfirming) {
            setRecords(prev => prev.filter(r => r.dateKey !== viewDateKey));
            setIsClearConfirming(false);
            showToast(t.clearedToast);
          } else {
            setIsClearConfirming(true);
            if (clearConfirmTimeout.current) clearTimeout(clearConfirmTimeout.current);
            clearConfirmTimeout.current = setTimeout(() => setIsClearConfirming(false), 3000);
          }
        };

        const copyFromLastWorkout = () => {
          const pastDates = [...new Set(records.map(r => r.dateKey))].filter(dk => dk < viewDateKey).sort();
          const lastDate = pastDates.pop();
          if (!lastDate) { showToast(t.noPastData); return; }
          const toCopy = records.filter(r => r.dateKey === lastDate);
          
          const cloned = toCopy.map((r, i) => ({
            ...r,
            id: String(Date.now() + Math.random() + i),
            dateKey: viewDateKey,
            val1: '', 
            val2: '', 
            val3: '',
            isNew: false,
            isHighlighted: r.isHighlighted,
            isCompleted: false,
            createdAt: Date.now(),
            sortOrder: records.length + i
          }));
          
          setRecords(prev => [...prev, ...cloned]);
          showToast(`${t.copySuccess} ${lastDate} ðŸ“‹`);
        };

        const updateRecord = (id, field, value) => { setRecords(prev => prev.map(r => r.id === id ? { ...r, [field]: value } : r)); };
        const deleteRecord = (id) => { setRecords(prev => prev.filter(r => r.id !== id)); };

        const handleDragStart = (e, index) => { setDraggedIdx(index); setIsDraggingInProgress(true); };
        const handleDragOver = (e, index) => {
          e.preventDefault();
          if (draggedIdx === null || draggedIdx === index) return;
          const itemMoving = currentRecords[draggedIdx];
          const targetItem = currentRecords[index];
          setRecords(prev => {
            const next = [...prev];
            const idxM = next.findIndex(r => r.id === itemMoving.id);
            const idxT = next.findIndex(r => r.id === targetItem.id);
            if (idxM === -1 || idxT === -1) return prev;
            const updated = [...next];
            const [removed] = updated.splice(idxM, 1);
            updated.splice(idxT, 0, removed);
            return updated;
          });
          setDraggedIdx(index);
        };
        const handleDragEnd = () => { setDraggedIdx(null); setIsDraggingInProgress(false); };

        if (!isLoaded) return null;

        return (
          <div className="min-h-screen max-w-md mx-auto flex flex-col relative pb-10">
            <div className={`toast ${toast.show ? 'show' : ''}`}>{toast.message}</div>
            <StatsModal isOpen={isStatsOpen} onClose={() => setIsStatsOpen(false)} weights={weights} t={t} />
            <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} language={language} setLanguage={setLanguage} t={t} />

            <header className="px-4 pt-3 pb-1 sticky top-0 bg-slate-50/95 backdrop-blur-md z-40 border-b border-slate-100">
              <div className="flex justify-between items-center mb-1.5 px-2">
                <h1 className="text-[17px] font-black text-slate-900 tracking-tight">{t.appName}</h1>
                <div className="flex items-center gap-1 bg-slate-200/50 rounded-lg px-2 py-0.5">
                   <span className="text-[9px] font-bold text-slate-500 uppercase tracking-tighter">{t.weight}</span>
                   <input type="text" inputMode="decimal" value={currentWeight} onChange={(e) => handleWeightChange(e.target.value)} placeholder="--" className="w-10 bg-transparent border-none text-center text-sm font-black text-slate-900 focus:outline-none placeholder:text-slate-400" />
                   <span className="text-[9px] font-bold text-slate-400">{t.kg}</span>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={() => setIsStatsOpen(true)} className="p-1 text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.stats}>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                  </button>
                  <button onClick={() => setIsSettingsOpen(true)} className="p-1 text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.settings}>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  </button>
                  <button onClick={exportJSON} className="p-1 text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.export}>
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M8 8l4 4m0 0l4-4m-4 4V4" /></svg>
                  </button>
                  <button onClick={handleManualSave} className="p-1 text-slate-900 hover:text-slate-900 active:scale-125 transition-transform" title={t.save}>
                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                  </button>
                </div>
              </div>

              <div className="flex items-center justify-between bg-white/60 rounded-xl p-0.5 border border-slate-200/50 shadow-sm">
                <button onClick={() => changeDate(-1)} className="nav-btn"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M15 19l-7-7 7-7" /></svg></button>
                <div onClick={() => setViewDate(new Date())} className="flex items-center cursor-pointer py-1"><span className="text-xs font-black text-slate-900 tabular-nums">{displayDate}</span></div>
                <button onClick={() => changeDate(1)} className="nav-btn"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M9 5l7 7-7 7" /></svg></button>
              </div>
            </header>

            <main className="px-4 pb-12 pt-1.5 flex flex-col items-start">
              <div className="w-full">
                {currentRecords.map((r, idx) => (
                  <TrackerItem key={r.id} record={r} index={idx} onDelete={deleteRecord} onUpdate={updateRecord} onDragStart={handleDragStart} onDragOver={handleDragOver} onDragEnd={handleDragEnd} isDragging={draggedIdx === idx} t={t} />
                ))}
              </div>
              
              {currentRecords.length === 0 && (
                <div className="w-full py-12 flex flex-col items-center justify-center gap-6">
                  <button onClick={copyFromLastWorkout} className="secondary-button"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" /></svg>{t.repeatLast}</button>
                </div>
              )}

              <div className="flex flex-col gap-3 mt-1.5 ml-1 w-full pr-1">
                <button 
                  onClick={addNewRecord} 
                  className="action-button w-full h-11 bg-slate-900 text-white rounded-xl flex items-center justify-center gap-2 shadow-lg"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M12 6v12m6-6H6" />
                  </svg>
                  <span className="text-sm font-bold">{t.addExercise}</span>
                </button>
                
                {currentRecords.length > 0 && (
                  <button 
                    onClick={deleteAllForCurrentDay} 
                    className={`action-button w-full h-11 rounded-xl flex items-center justify-center gap-2 shadow-md transition-all ${isClearConfirming ? 'bg-red-500 text-white scale-[1.02]' : 'bg-white text-slate-400 border border-slate-200'}`}
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      {isClearConfirming ? (
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12" />
                      ) : (
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      )}
                    </svg>
                    <span className="text-xs font-bold uppercase tracking-wider">
                      {isClearConfirming ? t.clearConfirm : t.clearBtn}
                    </span>
                  </button>
                )}
              </div>
            </main>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
