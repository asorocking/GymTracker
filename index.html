
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#f8fafc" />
    
    <!-- Favicon & Icons -->
    <link rel="icon" type="image/png" href="list.png" />
    <link rel="apple-touch-icon" href="list.png" />
    
    <!-- PWA Settings -->
    <link rel="manifest" href="/GymTracker/manifest.json">
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="GymTracker" />
    
    <title>GymTracker Pro</title>
    
    <script src="https://unpkg.com/react@18.3.1/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.10/babel.min.js"></script>
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      #root:empty::before {
        content: "";
        display: block;
        width: 24px;
        height: 24px;
        margin: 45vh auto 0;
        border: 2px solid #e2e8f0;
        border-top-color: #0f172a;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      
      body {
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior-y: contain;
        background-color: #f8fafc;
        height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      
      .fade-in {
        animation: fadeIn 0.2s ease-out forwards;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .tracker-item {
        position: relative;
        transition: box-shadow 0.2s ease, opacity 0.2s ease, height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform, opacity;
      }
      
      .tracker-item.dragging {
        opacity: 0.1;
        box-shadow: none;
      }

      .drag-handle {
        cursor: grab;
        touch-action: none;
      }
      .drag-handle:active {
        cursor: grabbing;
      }
      
      textarea, input[type="text"], input[type="date"], input[type="time"] {
        appearance: none;
        -webkit-appearance: none;
      }

      textarea {
        resize: none !important;
      }

      .delete-btn-active {
        color: #ef4444 !important;
        background-color: #fef2f2;
        border-radius: 6px;
      }

      .action-button {
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
      }
      .action-button:active {
        transform: scale(0.92);
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
      }

      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        padding: 12px 20px;
        border-radius: 99px;
        background: #0f172a;
        color: white;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        pointer-events: none;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .toast.show {
        opacity: 1;
        top: 30px;
      }

      .nav-btn {
        @apply p-1 text-slate-500 hover:text-slate-900 transition-all active:scale-125;
      }

      .modal-backdrop {
        background: rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      .suggestions-list {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(226, 232, 240, 1);
        border-radius: 14px;
        box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        max-height: 200px;
        overflow-y: auto;
        padding: 4px;
        animation: suggestionsIn 0.2s ease-out forwards;
      }

      @keyframes suggestionsIn {
        from { opacity: 0; transform: translateY(-4px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .suggestion-item {
        @apply px-3 py-2 text-[12px] font-bold text-slate-600 rounded-[10px] transition-all cursor-pointer;
        display: flex;
        align-items: center;
        margin-bottom: 2px;
      }
      
      .suggestion-item:active {
        @apply bg-slate-100 text-slate-900;
      }

      input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
      }
      input[type=range]:focus {
        outline: none;
      }
      input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 6px;
        cursor: pointer;
        background: #e2e8f0;
        border-radius: 3px;
      }
      input[type=range]::-webkit-slider-thumb {
        height: 18px;
        width: 18px;
        border-radius: 50%;
        background: #0f172a;
        cursor: pointer;
        -webkit-appearance: none;
        margin-top: -6px;
      }

      .color-picker-wrapper {
        position: relative;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: 2px solid #e2e8f0;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .color-picker-wrapper:active {
        transform: scale(0.9);
      }
      .color-picker-wrapper input[type="color"] {
        position: absolute;
        top: -10px;
        left: -10px;
        width: 64px;
        height: 64px;
        border: none;
        padding: 0;
        cursor: pointer;
      }

      .mode-toggle {
        cursor: pointer;
        transition: opacity 0.2s;
        user-select: none;
      }
      .mode-toggle:active {
        opacity: 0.6;
      }

      .custom-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1rem;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 22px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #e2e8f0;
        transition: .4s;
        border-radius: 22px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 16px; width: 16px;
        left: 3px; bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #0f172a;
      }
      input:checked + .slider:before {
        transform: translateX(18px);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
      }
      .calendar-day-header {
        @apply text-[10px] font-black text-slate-400 uppercase text-center py-2;
      }
      .calendar-day-cell {
        @apply relative aspect-square flex items-center justify-center text-xs font-bold rounded-xl transition-all active:scale-90 cursor-pointer;
      }
      .calendar-day-trained::after {
        content: '';
        @apply absolute bottom-1.5 w-1 h-1 bg-emerald-500 rounded-full;
      }
      .calendar-day-scheduled {
        @apply border border-dashed border-slate-200;
      }
      .calendar-day-selected {
        @apply bg-slate-900 text-white shadow-lg z-10;
      }
      .calendar-day-today {
        @apply border-2 border-slate-900 text-slate-900;
      }
      .calendar-day-outside {
        @apply opacity-20;
      }

      .expanded-content {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 0;
        opacity: 0;
      }
      .expanded-content.show {
        max-height: 500px;
        opacity: 1;
        padding-top: 8px;
        padding-bottom: 8px;
      }

      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      
      .strike-through {
        text-decoration: line-through;
      }
    </style>
  </head>
  <body class="antialiased text-slate-900">
    <div id="root"></div>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered'))
            .catch(err => console.log('SW error', err));
        });
      }
    </script>

    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect, useRef, useMemo } = React;

      const i18n = {
        ru: {
          appName: "GymTracker",
          shopName: "ShopTracker",
          pressureName: "120/80",
          cookName: "Cook",
          kbzhuName: "–ö–ë–ñ–£",
          calculate: "–†–∞—Å—á–∏—Ç–∞—Ç—å",
          weight: "–í–µ—Å",
          kg: "–∫–≥",
          gr: "–≥—Ä.",
          stats: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
          export: "–≠–∫—Å–ø–æ—Ä—Ç",
          import: "–ò–º–ø–æ—Ä—Ç",
          save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
          progress: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
          bodyWeight: "–í–µ—Å —Ç–µ–ª–∞",
          exerciseStats: "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è",
          selectExercise: "–í—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ",
          noData: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö",
          close: "–ó–∞–∫—Ä—ã—Ç—å",
          recordPlaceholder: "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ...",
          weightPlaceholder: "–í–µ—Å",
          notesPlaceholder: "–ü–æ–º–µ—Ç–∫–∏...",
          shopPlaceholder: "–ö—É–ø–∏—Ç—å...",
          cookPlaceholder: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞...",
          kbzhuPlaceholder: "–ü—Ä–æ–¥—É–∫—Ç...",
          recipeContentPlaceholder: "–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ —Å–ø–æ—Å–æ–± –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è...",
          cookSearchPlaceholder: "–ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–∞...",
          savedToast: "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ üíæ",
          errorToast: "–û—à–∏–±–∫–∞ ‚ö†Ô∏è",
          exportToast: "–≠–∫—Å–ø–æ—Ä—Ç üì§",
          importToast: "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ",
          addExercise: "–î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ",
          addItem: "–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫",
          addPressure: "–ù–æ–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ",
          addRecipe: "–ù–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç",
          addKbzhu: "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å",
          repeatLast: "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ—à–ª—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É",
          noPastData: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ü§∑‚Äç‚ôÇÔ∏è",
          copySuccess: "–ö–æ–ø–∏—è:",
          clearConfirm: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ?",
          clearBtn: "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏",
          clearedToast: "–û—á–∏—â–µ–Ω–æ üóëÔ∏è",
          settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
          language: "–Ø–∑—ã–∫",
          russian: "–†—É—Å—Å–∫–∏–π",
          english: "English",
          uiSettings: "–í–Ω–µ—à–Ω–∏–π –≤–∏–¥",
          uiSettingsGym: "–í–∏–¥: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞",
          uiSettingsShop: "–í–∏–¥: –ú–∞–≥–∞–∑–∏–Ω",
          uiSettingsPressure: "–í–∏–¥: –î–∞–≤–ª–µ–Ω–∏–µ",
          uiSettingsCook: "–í–∏–¥: –†–µ—Ü–µ–ø—Ç—ã",
          uiSettingsKbzhu: "–í–∏–¥: –ö–ë–ñ–£",
          itemHeight: "–í—ã—Å–æ—Ç–∞ –∑–∞–ø–∏—Å–∏",
          itemWidth: "–®–∏—Ä–∏–Ω–∞ –∑–∞–ø–∏—Å–∏",
          itemSpacing: "–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø–∏—Å—è–º–∏",
          colorHighlight: "–°–µ—Ç/–ê–∫—Ü–µ–Ω—Ç",
          colorCompleted: "–ì–æ—Ç–æ–≤–æ",
          bgColor: "–¶–≤–µ—Ç —Ñ–æ–Ω–∞",
          weightColor: "–¶–≤–µ—Ç —à—Ä–∏—Ñ—Ç–∞ –≤–µ—Å–∞",
          fontSize: "–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞",
          lineCount: "–ß–∏—Å–ª–æ —Å—Ç—Ä–æ–∫ –≤ –∑–∞–ø–∏—Å–∏",
          modeSwitched: "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ ",
          exerciseLibrary: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π",
          shopLibrary: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤",
          cookLibrary: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤",
          kbzhuLibrary: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ö–ë–ñ–£",
          libraryEmpty: "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å—å.",
          count: "—Ä–∞–∑",
          start: "–ù–∞—á–∞—Ç—å",
          finish: "–ó–∞–∫–æ–Ω—á–∏—Ç—å",
          resetToast: "–í—Ä–µ–º—è —Å–±—Ä–æ—à–µ–Ω–æ ‚è±Ô∏è",
          workoutTime: "–í—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏",
          listNameLabel: "–ù–∞–∑–≤–∞–Ω–∏–µ",
          defaultListName: "–ù–æ–≤—ã–π —Å–ø–∏—Å–æ–∫",
          deleteEmptyLists: "–û—á–∏—Å—Ç–∏—Ç—å –ø—É—Å—Ç—ã–µ —Å–ø–∏—Å–∫–∏",
          addItemToLibrary: "–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É",
          editItemPlaceholder: "–ù–∞–∑–≤–∞–Ω–∏–µ...",
          alreadyExists: "–£–∂–µ –≤ —Å–ø–∏—Å–∫–µ!",
          toastDurationLabel: "–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Å–µ–∫)",
          maxWorkoutTimeLabel: "–õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (—á–∞—Å)",
          enableToastsLabel: "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
          deleteListConfirm: "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ –∏ –≤—Å–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏?",
          listDeletedToast: "–°–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω üóëÔ∏è",
          tabGeneral: "–û–±—â–∏–µ",
          tabLibraryGym: "–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è",
          tabLibraryShop: "–¢–æ–≤–∞—Ä—ã",
          tabLibraryCook: "–†–µ—Ü–µ–ø—Ç—ã",
          tabLibraryKbzhu: "–ö–ë–ñ–£",
          tabLists: "–°–ø–∏—Å–∫–∏",
          listManagement: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞–º–∏",
          dragToReorder: "–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏",
          renameListPlaceholder: "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å...",
          enableSuggestionsLabel: "–ü–æ–¥—Å–∫–∞–∑–∫–∏ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏",
          upperLabel: "–í–µ—Ä—Ö–Ω–µ–µ",
          lowerLabel: "–ù–∏–∂–Ω–µ–µ",
          pulseLabel: "–ü—É–ª—å—Å",
          timeLabel: "Time",
          dateLabel: "Date",
          commentPlaceholder: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...",
          calendarTitle: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫",
          daysShort: ["–í—Å", "–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±"],
          months: ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"]
        },
        en: {
          appName: "GymTracker",
          shopName: "ShopTracker",
          pressureName: "120/80",
          cookName: "Cook",
          kbzhuName: "Macros",
          calculate: "Calculate",
          weight: "Weight",
          kg: "kg",
          gr: "g.",
          stats: "Stats",
          export: "Export",
          import: "Import",
          save: "Save",
          progress: "Statistics",
          bodyWeight: "Body Weight",
          exerciseStats: "Exercises",
          selectExercise: "Select exercise",
          noData: "Not enough data",
          close: "Close",
          recordPlaceholder: "Exercise...",
          weightPlaceholder: "Wgt",
          notesPlaceholder: "Notes...",
          shopPlaceholder: "Buy...",
          cookPlaceholder: "Recipe title...",
          kbzhuPlaceholder: "Product...",
          recipeContentPlaceholder: "Ingredients and instructions...",
          cookSearchPlaceholder: "Search recipe...",
          savedToast: "Saved üíæ",
          errorToast: "Error ‚ö†Ô∏è",
          exportToast: "Exported üì§",
          importToast: "Imported ‚úÖ",
          addExercise: "Add Exercise",
          addItem: "Add to List",
          addPressure: "New Measurement",
          addRecipe: "New Recipe",
          addKbzhu: "Add Record",
          repeatLast: "Repeat last workout",
          noPastData: "No data ü§∑‚Äç‚ôÇÔ∏è",
          copySuccess: "Copied:",
          clearConfirm: "Confirm clear?",
          clearBtn: "Delete all records",
          clearedToast: "Cleared üóëÔ∏è",
          settings: "Settings",
          language: "Language",
          russian: "Russian",
          english: "English",
          uiSettings: "Appearance",
          uiSettingsGym: "UI: Gym Mode",
          uiSettingsShop: "UI: Shop Mode",
          uiSettingsPressure: "UI: 120/80 Mode",
          uiSettingsCook: "UI: Cook Mode",
          uiSettingsKbzhu: "UI: Macros Mode",
          itemHeight: "Item Height",
          itemWidth: "Item Width",
          itemSpacing: "Item Spacing",
          colorHighlight: "Set Color",
          colorCompleted: "Done Color",
          bgColor: "Background Color",
          weightColor: "Weight font color",
          fontSize: "Font Size",
          lineCount: "Number of Lines",
          modeSwitched: "Switched to ",
          exerciseLibrary: "Exercise Library",
          shopLibrary: "Shop Library",
          cookLibrary: "Recipe Library",
          kbzhuLibrary: "Macros Library",
          libraryEmpty: "Library is empty. Add items.",
          count: "times",
          start: "Start",
          finish: "Finish",
          resetToast: "Timer reset ‚è±Ô∏è",
          workoutTime: "Workout Time",
          listNameLabel: "List Name",
          defaultListName: "New List",
          deleteEmptyLists: "Clear empty lists",
          addItemToLibrary: "Add to library",
          editItemPlaceholder: "Name...",
          alreadyExists: "Already exists!",
          toastDurationLabel: "Toast duration (sec)",
          maxWorkoutTimeLabel: "Workout time limit (hrs)",
          enableToastsLabel: "Show notifications",
          deleteListConfirm: "Delete this list and all its items?",
          listDeletedToast: "List deleted üóëÔ∏è",
          tabGeneral: "General",
          tabLibraryGym: "Exercises",
          tabLibraryShop: "Items",
          tabLibraryCook: "Recipes",
          tabLibraryKbzhu: "Macros",
          tabLists: "Lists",
          listManagement: "Manage Lists",
          dragToReorder: "Drag to reorder",
          renameListPlaceholder: "Rename...",
          enableSuggestionsLabel: "Library suggestions",
          upperLabel: "Upper",
          lowerLabel: "Lower",
          pulseLabel: "Pulse",
          timeLabel: "Time",
          dateLabel: "Date",
          commentPlaceholder: "Comment...",
          calendarTitle: "Workout Calendar",
          daysShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
          months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
        }
      };

      const DB_NAME = 'TrackerDB';
      const STORE_RECORDS = 'records';
      const STORE_WEIGHTS = 'weights';
      const STORE_SESSIONS = 'sessions';
      const DB_VERSION = 4;

      const initDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);
          request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_RECORDS)) {
              db.createObjectStore(STORE_RECORDS, { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains(STORE_WEIGHTS)) {
              db.createObjectStore(STORE_WEIGHTS, { keyPath: 'dateKey' });
            }
            if (!db.objectStoreNames.contains(STORE_SESSIONS)) {
              db.createObjectStore(STORE_SESSIONS, { keyPath: 'dateKey' });
            }
          };
          request.onsuccess = (e) => resolve(e.target.result);
          request.onerror = (e) => reject(e.target.error);
        });
      };

      const saveToDB = async (records) => {
        if (!records) return;
        const db = await initDB();
        const tx = db.transaction(STORE_RECORDS, 'readwrite');
        const store = tx.objectStore(STORE_RECORDS);
        
        return new Promise((resolve, reject) => {
          const clearReq = store.clear();
          clearReq.onsuccess = () => {
            if (records.length === 0) {
              resolve();
              return;
            }
            records.forEach((r, index) => {
              store.put({ ...r, sortOrder: index });
            });
            tx.oncomplete = () => resolve();
            tx.onerror = () => reject(tx.error);
          };
          clearReq.onerror = () => reject(clearReq.error);
        });
      };

      const loadFromDB = async () => {
        const db = await initDB();
        const tx = db.transaction(STORE_RECORDS, 'readonly');
        const store = tx.objectStore(STORE_RECORDS);
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => {
            const results = request.result || [];
            const sorted = results.sort((a, b) => (a.sortOrder ?? 0) - (b.sortOrder ?? 0));
            resolve(sorted);
          };
        });
      };

      const saveWeightToDB = async (dateKey, weight) => {
        const db = await initDB();
        const tx = db.transaction(STORE_WEIGHTS, 'readwrite');
        const store = tx.objectStore(STORE_WEIGHTS);
        return new Promise((resolve, reject) => {
          store.put({ dateKey, weight });
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      };

      const loadWeightsFromDB = async () => {
        const db = await initDB();
        const tx = db.transaction(STORE_WEIGHTS, 'readonly');
        const store = tx.objectStore(STORE_WEIGHTS);
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => {
            const weightsMap = {};
            request.result.forEach(item => { weightsMap[item.dateKey] = item.weight; });
            resolve(weightsMap);
          };
        });
      };

      const saveSessionToDB = async (dateKey, session) => {
        const db = await initDB();
        const tx = db.transaction(STORE_SESSIONS, 'readwrite');
        const store = tx.objectStore(STORE_SESSIONS);
        return new Promise((resolve, reject) => {
          store.put({ dateKey, ...session });
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      };

      const loadSessionsFromDB = async () => {
        const db = await initDB();
        const tx = db.transaction(STORE_SESSIONS, 'readonly');
        const store = tx.objectStore(STORE_SESSIONS);
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => {
            const sessionsMap = {};
            request.result.forEach(item => { 
                const { dateKey, ...rest } = item;
                sessionsMap[dateKey] = rest; 
            });
            resolve(sessionsMap);
          };
        });
      };

      const getDateKey = (date) => {
        const d = new Date(date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      };

      const CalendarModal = ({ isOpen, onClose, selectedDate, setSelectedDate, records, t }) => {
        const [currentMonth, setCurrentMonth] = useState(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1));
        
        if (!isOpen) return null;

        const trainedDates = useMemo(() => {
          const dates = new Set();
          records.forEach(r => {
            if (r.mode === 'gym' || !r.mode) {
              dates.add(r.dateKey);
            }
          });
          return dates;
        }, [records]);

        const daysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
        const firstDayOfMonth = (month, year) => new Date(year, month, 1).getDay();

        const changeMonth = (offset) => {
          setCurrentMonth(prev => new Date(prev.getFullYear(), prev.getMonth() + offset, 1));
        };

        const today = new Date();
        const todayKey = getDateKey(today);
        const selectedKey = getDateKey(selectedDate);

        const calendarDays = [];
        const month = currentMonth.getMonth();
        const year = currentMonth.getFullYear();
        const daysCount = daysInMonth(month, year);
        const startDay = firstDayOfMonth(month, year);

        // Previous month filler
        const prevMonth = new Date(year, month - 1, 1);
        const prevMonthDaysCount = daysInMonth(prevMonth.getMonth(), prevMonth.getFullYear());
        for (let i = startDay - 1; i >= 0; i--) {
          calendarDays.push({
            day: prevMonthDaysCount - i,
            month: month - 1,
            year: year,
            isOutside: true
          });
        }

        // Current month
        for (let i = 1; i <= daysCount; i++) {
          calendarDays.push({
            day: i,
            month: month,
            year: year,
            isOutside: false
          });
        }

        // Next month filler
        const remaining = 42 - calendarDays.length;
        for (let i = 1; i <= remaining; i++) {
          calendarDays.push({
            day: i,
            month: month + 1,
            year: year,
            isOutside: true
          });
        }

        const isScheduledDay = (d) => {
          const dayOfWeek = d.getDay();
          return [1, 3, 5].includes(dayOfWeek);
        };

        const handleDateClick = (d) => {
          const target = new Date(d.year, d.month, d.day);
          setSelectedDate(target);
          onClose();
        };

        return (
          <div className="fixed inset-0 z-[1200] flex items-center justify-center p-4 modal-backdrop fade-in">
            <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden flex flex-col">
              <div className="px-6 pt-6 pb-2 flex justify-between items-center border-b border-slate-50">
                <h2 className="text-lg font-black text-slate-900 tracking-tight">{t.calendarTitle}</h2>
                <button onClick={onClose} className="p-2 -mr-2 text-slate-400">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <div className="p-6">
                <div className="flex items-center justify-between mb-4">
                  <button onClick={() => changeMonth(-1)} className="p-2 text-slate-400 hover:text-slate-900"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M15 19l-7-7 7-7" /></svg></button>
                  <span className="text-sm font-black text-slate-800 uppercase tracking-widest">{t.months[month]} {year}</span>
                  <button onClick={() => changeMonth(1)} className="p-2 text-slate-400 hover:text-slate-900"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M9 5l7 7-7 7" /></svg></button>
                </div>

                <div className="calendar-grid">
                  {t.daysShort.map(d => <div key={d} className="calendar-day-header">{d}</div>)}
                  {calendarDays.map((d, idx) => {
                    const dateObj = new Date(d.year, d.month, d.day);
                    const key = getDateKey(dateObj);
                    const isToday = key === todayKey;
                    const isSelected = key === selectedKey;
                    const isTrained = trainedDates.has(key);
                    const isFuture = dateObj > today;
                    const scheduled = isFuture && isScheduledDay(dateObj);
                    
                    return (
                      <div 
                        key={idx} 
                        onClick={() => handleDateClick(d)}
                        className={`calendar-day-cell 
                          ${d.isOutside ? 'calendar-day-outside' : ''} 
                          ${isSelected ? 'calendar-day-selected' : ''} 
                          ${isToday && !isSelected ? 'calendar-day-today' : ''}
                          ${isTrained ? 'calendar-day-trained' : ''}
                          ${scheduled ? 'calendar-day-scheduled' : ''}
                        `}
                      >
                        {d.day}
                      </div>
                    );
                  })}
                </div>
              </div>
              
              <div className="px-6 pb-6 pt-2">
                <button onClick={() => { setSelectedDate(new Date()); onClose(); }} className="w-full py-3 bg-slate-100 text-slate-900 font-bold rounded-xl active:scale-95 mb-2">{t.repeatLast.includes('–ø—Ä–æ—à–ª—É—é') ? '–°–µ–≥–æ–¥–Ω—è' : 'Today'}</button>
                <button onClick={onClose} className="w-full py-3 bg-slate-900 text-white font-bold rounded-xl active:scale-95">{t.close}</button>
              </div>
            </div>
          </div>
        );
      };

      const LibraryEditor = ({ items, onAdd, onDelete, onEdit, t, placeholder, mode }) => {
        const [newItem, setNewItem] = useState(mode === 'kbzhu' ? { name: '', k: '', b: '', j: '', u: '' } : '');
        
        const handleAdd = () => {
          if (mode === 'kbzhu') {
            if (!newItem.name.trim()) return;
            onAdd({ ...newItem, name: newItem.name.trim() });
            setNewItem({ name: '', k: '', b: '', j: '', u: '' });
          } else {
            if (!newItem.trim()) return;
            if (items.includes(newItem.trim())) {
               alert(t.alreadyExists);
               return;
            }
            onAdd(newItem.trim());
            setNewItem('');
          }
        };

        const updateNewKbzhu = (field, val) => {
          setNewItem(prev => ({ ...prev, [field]: val }));
        };

        const updateExistingKbzhu = (index, field, val) => {
          const updated = { ...items[index], [field]: val };
          onEdit(index, updated);
        };

        return (
          <div className="flex flex-col gap-3">
            {mode === 'kbzhu' ? (
              <div className="flex flex-col gap-2 p-3 bg-slate-50 rounded-xl border border-slate-200">
                <div className="flex gap-2">
                  <input 
                    type="text" 
                    value={newItem.name} 
                    onChange={(e) => updateNewKbzhu('name', e.target.value)} 
                    placeholder={t.kbzhuPlaceholder}
                    className="flex-1 bg-white border border-slate-200 rounded-lg px-3 py-1.5 text-xs font-bold focus:outline-none"
                  />
                  <button onClick={handleAdd} className="p-2 bg-slate-900 text-white rounded-lg active:scale-95 transition-transform">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M12 6v12m6-6H6" /></svg>
                  </button>
                </div>
                <div className="grid grid-cols-4 gap-2">
                  {['k', 'b', 'j', 'u'].map((f, i) => (
                    <div key={f} className="flex flex-col gap-0.5">
                      <span className="text-[7px] font-black text-slate-400 uppercase text-center leading-none">{['–∫','–±','–∂','—É'][i]}</span>
                      <input 
                        type="text" inputMode="decimal"
                        value={newItem[f]} 
                        onChange={(e) => updateNewKbzhu(f, e.target.value.replace(',', '.').replace(/[^0-9.]/g, ''))}
                        className="w-full bg-white border border-slate-200 rounded-lg py-1 text-[10px] font-black text-center focus:outline-none"
                        placeholder="0"
                      />
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              <div className="flex gap-2">
                <input 
                  type="text" 
                  value={newItem} 
                  onChange={(e) => setNewItem(e.target.value)} 
                  onKeyDown={(e) => e.key === 'Enter' && handleAdd()}
                  placeholder={placeholder || t.addItemToLibrary} 
                  className="flex-1 bg-white border border-slate-200 rounded-xl px-4 py-2 text-sm font-semibold focus:ring-2 focus:ring-slate-900 focus:outline-none" 
                />
                <button onClick={handleAdd} className="p-2.5 bg-slate-900 text-white rounded-xl active:scale-95 transition-transform">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M12 6v12m6-6H6" /></svg>
                </button>
              </div>
            )}
            
            <div className="bg-slate-50 rounded-2xl border border-slate-100 overflow-hidden max-h-[300px] overflow-y-auto">
              {items.length > 0 ? (
                items.map((item, index) => (
                  <div key={index} className="flex flex-col px-4 py-3 border-b border-slate-100 last:border-0 gap-2 group">
                    <div className="flex items-center gap-3">
                      <input 
                        type="text" 
                        value={mode === 'kbzhu' ? item.name : item} 
                        onChange={(e) => onEdit(index, mode === 'kbzhu' ? { ...item, name: e.target.value } : e.target.value)}
                        className="flex-1 bg-transparent border-none outline-none text-sm font-bold text-slate-700 focus:text-slate-900 p-0"
                      />
                      <button onClick={() => onDelete(index)} className="p-1.5 text-slate-300 hover:text-red-500 transition-colors">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                      </button>
                    </div>
                    {mode === 'kbzhu' && (
                      <div className="grid grid-cols-4 gap-2">
                        {['k', 'b', 'j', 'u'].map((f, i) => (
                          <div key={f} className="flex flex-col gap-0.5">
                            <span className="text-[6px] font-black text-slate-400 uppercase text-center leading-none">{['–∫','–±','–∂','—É'][i]}</span>
                            <input 
                              type="text" inputMode="decimal"
                              value={item[f] || ''} 
                              onChange={(e) => updateExistingKbzhu(index, f, e.target.value.replace(',', '.').replace(/[^0-9.]/g, ''))}
                              className="w-full bg-white/50 border border-slate-100 rounded-lg py-0.5 text-[10px] font-black text-center focus:outline-none"
                              placeholder="0"
                            />
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                ))
              ) : (
                <div className="p-8 text-center text-xs font-bold text-slate-400 italic">
                  {t.libraryEmpty}
                </div>
              )}
            </div>
          </div>
        );
      };

      const ListManagementTab = ({ shopListRegistry, setShopListRegistry, onRenameList, t }) => {
        const [draggedIdx, setDraggedIdx] = useState(null);

        const handleDragStart = (e, index) => {
          setDraggedIdx(index);
          e.dataTransfer.effectAllowed = 'move';
        };

        const handleDragOver = (e, index) => {
          e.preventDefault();
          if (draggedIdx === null || draggedIdx === index) return;
          const newList = [...shopListRegistry];
          const [removed] = newList.splice(draggedIdx, 1);
          newList.splice(index, 0, removed);
          setShopListRegistry(newList);
          setDraggedIdx(index);
        };

        const handleDragEnd = () => setDraggedIdx(null);

        const handleDelete = (index) => {
          if (confirm(t.deleteListConfirm)) {
            setShopListRegistry(prev => prev.filter((_, i) => i !== index));
          }
        };

        const toggleEnabled = (index) => {
          setShopListRegistry(prev => prev.map((item, i) => i === index ? { ...item, enabled: !item.enabled } : item));
        };

        return (
          <div className="flex flex-col gap-4">
            <p className="text-[10px] font-bold text-slate-400 italic uppercase tracking-widest">{t.dragToReorder}</p>
            <div className="flex flex-col gap-2">
              {shopListRegistry.map((listItem, idx) => (
                <div 
                  key={listItem.name} 
                  draggable 
                  onDragStart={(e) => handleDragStart(e, idx)}
                  onDragOver={(e) => handleDragOver(e, idx)}
                  onDragEnd={handleDragEnd}
                  className={`flex items-center gap-3 px-3 py-3 bg-slate-50 border border-slate-100 rounded-xl transition-all ${draggedIdx === idx ? 'opacity-40 scale-95 shadow-inner' : 'hover:border-slate-300'}`}
                >
                  <div className="shrink-0 flex flex-col gap-0.5 opacity-20 cursor-grab px-1">
                    <div className="flex gap-0.5"><div className="w-0.5 h-0.5 bg-slate-900 rounded-full"></div><div className="w-0.5 h-0.5 bg-slate-900 rounded-full"></div></div>
                    <div className="flex gap-0.5"><div className="w-0.5 h-0.5 bg-slate-900 rounded-full"></div><div className="w-0.5 h-0.5 bg-slate-900 rounded-full"></div></div>
                  </div>
                  
                  <div className="flex-1 flex flex-col gap-1 min-w-0">
                    <input 
                      type="text" 
                      value={listItem.name} 
                      onChange={(e) => onRenameList(listItem.name, e.target.value)}
                      className="w-full bg-transparent border-none outline-none text-sm font-black text-slate-800"
                      placeholder={t.renameListPlaceholder}
                    />
                    <div className="flex items-center gap-2">
                      <label className="switch scale-75 origin-left">
                        <input type="checkbox" checked={!!listItem.enabled} onChange={() => toggleEnabled(idx)} />
                        <span className="slider"></span>
                      </label>
                      <span className="text-[9px] font-bold text-slate-400 uppercase tracking-tight">{t.enableSuggestionsLabel}</span>
                    </div>
                  </div>

                  <button onClick={() => handleDelete(idx)} className="p-1 text-slate-300 hover:text-red-500 transition-colors shrink-0">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                  </button>
                </div>
              ))}
              {shopListRegistry.length === 0 && (
                <div className="p-8 text-center text-xs font-bold text-slate-400 italic bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                  {t.libraryEmpty}
                </div>
              )}
            </div>
          </div>
        );
      };

      const SettingsModal = ({ 
        isOpen, onClose, language, setLanguage, uiSettings, setUiSettings, 
        activeMode, exerciseRegistry, setExerciseRegistry, shopRegistry, setShopRegistry, 
        cookRegistry, setCookRegistry, kbzhuRegistry, setKbzhuRegistry,
        shopListRegistry, setShopListRegistry, onRenameShopList,
        clearRegistry, t 
      }) => {
        const [activeTab, setActiveTab] = useState('general');

        if (!isOpen) return null;

        const currentUISettings = uiSettings[activeMode] || {};

        const updateUI = (key, val) => {
          setUiSettings(prev => ({
            ...prev,
            [activeMode]: {
              ...prev[activeMode],
              [key]: val
            }
          }));
        };

        const getRegistryConfig = () => {
          if (activeMode === 'gym') return { items: exerciseRegistry, setter: setExerciseRegistry, title: t.exerciseLibrary };
          if (activeMode === 'shop') return { items: shopRegistry, setter: setShopRegistry, title: t.shopLibrary };
          if (activeMode === 'cook') return { items: cookRegistry, setter: setCookRegistry, title: t.cookLibrary };
          if (activeMode === 'kbzhu') return { items: kbzhuRegistry, setter: setKbzhuRegistry, title: t.kbzhuLibrary };
          return null;
        };

        const registryConfig = getRegistryConfig();

        const handleAdd = (val) => {
          if (activeMode === 'kbzhu') {
            registryConfig.setter(prev => [...prev, val].sort((a,b) => a.name.localeCompare(b.name)));
          } else {
            registryConfig.setter(prev => [...prev, val].sort((a,b) => a.localeCompare(b)));
          }
        };
        const handleDelete = (index) => registryConfig.setter(prev => prev.filter((_, i) => i !== index));
        const handleEdit = (index, val) => registryConfig.setter(prev => {
          const next = [...prev];
          next[index] = val;
          return next;
        });

        return (
          <div className="fixed inset-0 z-[1100] flex items-center justify-center p-4 modal-backdrop fade-in">
            <div className="bg-white w-full max-sm rounded-3xl shadow-2xl overflow-y-auto max-h-[90vh] flex flex-col">
              <div className="px-6 pt-6 pb-2 flex justify-between items-center border-b border-slate-50 sticky top-0 bg-white z-10">
                <h2 className="text-xl font-black text-slate-900 tracking-tight">{t.settings}</h2>
                <button onClick={onClose} className="p-2 -mr-2 text-slate-400">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <div className="px-6 pt-4 flex border-b border-slate-50 bg-white sticky top-[68px] z-10">
                <button onClick={() => setActiveTab('general')} className={`flex-1 pb-3 px-1 text-[10px] font-black uppercase tracking-widest text-center transition-all border-b-2 ${activeTab === 'general' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-400'}`}>{t.tabGeneral}</button>
                {activeMode !== 'pressure' && (<button onClick={() => setActiveTab('library')} className={`flex-1 pb-3 px-1 text-[10px] font-black uppercase tracking-widest text-center transition-all border-b-2 ${activeTab === 'library' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-400'}`}>{activeMode === 'gym' ? t.tabLibraryGym : activeMode === 'shop' ? t.tabLibraryShop : activeMode === 'cook' ? t.tabLibraryCook : t.tabLibraryKbzhu}</button>)}
                {activeMode === 'shop' && (<button onClick={() => setActiveTab('lists')} className={`flex-1 pb-3 px-1 text-[10px] font-black uppercase tracking-widest text-center transition-all border-b-2 ${activeTab === 'lists' ? 'border-slate-900 text-slate-900' : 'border-transparent text-slate-400'}`}>{t.tabLists}</button>)}
              </div>
              
              <div className="p-6 flex flex-col gap-8">
                {activeTab === 'general' && (
                  <React.Fragment>
                    <div>
                      <label className="block text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3">{t.language}</label>
                      <div className="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-xl">
                        <button onClick={() => setLanguage('ru')} className={`py-2 rounded-lg text-xs font-bold transition-all ${language === 'ru' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}>{t.russian}</button>
                        <button onClick={() => setLanguage('en')} className={`py-2 rounded-lg text-xs font-bold transition-all ${language === 'en' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}>{t.english}</button>
                      </div>
                    </div>

                    <div className="flex flex-col gap-4">
                      <label className="block text-[10px] font-black uppercase tracking-widest text-slate-400">
                        {activeMode === 'gym' ? t.uiSettingsGym : activeMode === 'shop' ? t.uiSettingsShop : activeMode === 'pressure' ? t.uiSettingsPressure : activeMode === 'cook' ? t.uiSettingsCook : t.uiSettingsKbzhu}
                      </label>
                      
                      <div className="space-y-4">
                        <div className="flex items-center justify-between">
                          <span className="text-[11px] font-bold text-slate-600">{t.enableToastsLabel}</span>
                          <label className="switch"><input type="checkbox" checked={currentUISettings.enableToasts !== false} onChange={(e) => updateUI('enableToasts', e.target.checked)} /><span className="slider"></span></label>
                        </div>
                        <div>
                          <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1"><span>{t.toastDurationLabel}</span><span>{currentUISettings.toastDuration || 3}—Å</span></div>
                          <input type="range" min="1" max="15" step="1" value={currentUISettings.toastDuration || 3} onChange={(e) => updateUI('toastDuration', parseInt(e.target.value))} />
                        </div>
                        {activeMode === 'gym' && (
                          <div>
                            <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1"><span>{t.maxWorkoutTimeLabel}</span><span>{currentUISettings.maxWorkoutTime || 4}—á</span></div>
                            <input type="range" min="1" max="24" step="1" value={currentUISettings.maxWorkoutTime || 4} onChange={(e) => updateUI('maxWorkoutTime', parseInt(e.target.value))} />
                          </div>
                        )}
                        <div>
                          <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1"><span>{t.fontSize}</span><span>{currentUISettings.fontSize}px</span></div>
                          <input type="range" min="8" max="24" step="1" value={currentUISettings.fontSize} onChange={(e) => updateUI('fontSize', parseInt(e.target.value))} />
                        </div>
                        {(activeMode === 'shop' || activeMode === 'cook' || activeMode === 'kbzhu') && (
                          <div>
                            <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1"><span>{t.lineCount}</span><span>{currentUISettings.lineCount}</span></div>
                            <input type="range" min="1" max="6" step="1" value={currentUISettings.lineCount} onChange={(e) => updateUI('lineCount', parseInt(e.target.value))} />
                          </div>
                        )}
                        <div>
                          <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1"><span>{t.itemHeight}</span><span>{currentUISettings.itemHeight}px</span></div>
                          <input type="range" min="30" max="150" step="2" value={currentUISettings.itemHeight} onChange={(e) => updateUI('itemHeight', parseInt(e.target.value))} />
                        </div>
                        <div>
                          <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1"><span>{t.itemWidth}</span><span>{currentUISettings.itemWidth}%</span></div>
                          <input type="range" min="70" max="100" step="1" value={currentUISettings.itemWidth} onChange={(e) => updateUI('itemWidth', parseInt(e.target.value))} />
                        </div>
                        <div>
                          <div className="flex justify-between text-[11px] font-bold text-slate-600 mb-1"><span>{t.itemSpacing}</span><span>{currentUISettings.itemSpacing}px</span></div>
                          <input type="range" min="0" max="32" step="2" value={currentUISettings.itemSpacing} onChange={(e) => updateUI('itemSpacing', parseInt(e.target.value))} />
                        </div>

                        <div className="grid grid-cols-2 gap-y-6 gap-x-4 pt-4 border-t border-slate-50">
                          <label className="flex flex-col items-center gap-2 cursor-pointer">
                            <div className="color-picker-wrapper" style={{ backgroundColor: currentUISettings.backgroundColor || '#f8fafc' }}>
                              <input type="color" value={currentUISettings.backgroundColor || '#f8fafc'} onChange={(e) => updateUI('backgroundColor', e.target.value)} />
                            </div>
                            <span className="text-[10px] font-black text-slate-500 uppercase text-center">{t.bgColor}</span>
                          </label>

                          <label className="flex flex-col items-center gap-2 cursor-pointer">
                            <div className="color-picker-wrapper" style={{ backgroundColor: currentUISettings.completedColor }}>
                              <input type="color" value={currentUISettings.completedColor} onChange={(e) => updateUI('completedColor', e.target.value)} />
                            </div>
                            <span className="text-[10px] font-black text-slate-500 uppercase text-center">{t.colorCompleted}</span>
                          </label>

                          {(activeMode === 'gym' || activeMode === 'cook' || activeMode === 'kbzhu') && (
                            <label className="flex flex-col items-center gap-2 cursor-pointer">
                              <div className="color-picker-wrapper" style={{ backgroundColor: currentUISettings.highlightColor }}>
                                <input type="color" value={currentUISettings.highlightColor} onChange={(e) => updateUI('highlightColor', e.target.value)} />
                              </div>
                              <span className="text-[10px] font-black text-slate-500 uppercase text-center">{t.colorHighlight}</span>
                            </label>
                          )}

                          {activeMode === 'gym' && (
                            <label className="flex flex-col items-center gap-2 cursor-pointer">
                              <div className="color-picker-wrapper" style={{ backgroundColor: currentUISettings.weightColor }}>
                                <input type="color" value={currentUISettings.weightColor} onChange={(e) => updateUI('weightColor', e.target.value)} />
                              </div>
                              <span className="text-[10px] font-black text-slate-500 uppercase text-center">{t.weightColor}</span>
                            </label>
                          )}
                        </div>
                      </div>
                    </div>
                  </React.Fragment>
                )}

                {activeTab === 'library' && registryConfig && (
                  <div className="flex flex-col gap-3">
                    <label className="block text-[10px] font-black uppercase tracking-widest text-slate-400">{registryConfig.title}</label>
                    <LibraryEditor items={registryConfig.items} onAdd={handleAdd} onDelete={handleDelete} onEdit={handleEdit} t={t} placeholder={t.editItemPlaceholder} mode={activeMode} />
                  </div>
                )}

                {activeTab === 'lists' && activeMode === 'shop' && (
                  <div className="flex flex-col gap-3">
                    <label className="block text-[10px] font-black uppercase tracking-widest text-slate-400">{t.listManagement}</label>
                    <ListManagementTab shopListRegistry={shopListRegistry} setShopListRegistry={setShopListRegistry} onRenameList={onRenameShopList} t={t} />
                  </div>
                )}
              </div>

              <div className="px-6 pb-6 pt-2 sticky bottom-0 bg-white shadow-[0_-10px_10px_-5px_rgba(255,255,255,1)]">
                <button onClick={onClose} className="w-full py-3 bg-slate-900 text-white font-bold rounded-xl active:scale-95">{t.close}</button>
              </div>
            </div>
          </div>
        );
      };

      const StatsModal = ({ isOpen, onClose, weights, records, knownExercises, t }) => {
        const [activeTab, setActiveTab] = useState('body');
        const [selectedExercise, setSelectedExercise] = useState('');
        const canvasRef = useRef(null);
        const chartInstance = useRef(null);

        useEffect(() => {
          if (!selectedExercise && knownExercises.length > 0) {
            setSelectedExercise(knownExercises[0]);
          }
        }, [knownExercises]);

        useEffect(() => {
          if (isOpen && canvasRef.current) {
            let labels = [];
            let data = [];
            let labelText = '';

            if (activeTab === 'body') {
              const sortedEntries = Object.entries(weights)
                .filter(([_, val]) => val !== '' && val !== null)
                .sort((a, b) => new Date(a[0]) - new Date(b[0]));

              if (sortedEntries.length > 0) {
                labels = sortedEntries.map(([date]) => {
                  const d = new Date(date);
                  return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                });
                data = sortedEntries.map(([_, val]) => parseFloat(val));
                labelText = t.weight;
              }
            } else {
              if (selectedExercise) {
                const exerciseRecords = records.filter(r => r.description.trim() === selectedExercise);
                const groupedByDate = {};
                
                exerciseRecords.forEach(r => {
                  const vals = [parseFloat(r.val1), parseFloat(r.val2), parseFloat(r.val3)].filter(v => !isNaN(v));
                  if (vals.length > 0) {
                    const maxVal = Math.max(...vals);
                    if (!groupedByDate[r.dateKey] || maxVal > groupedByDate[r.dateKey]) {
                      groupedByDate[r.dateKey] = maxVal;
                    }
                  }
                });

                const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(a) - new Date(b));
                labels = sortedDates.map(date => {
                  const d = new Date(date);
                  return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                });
                data = sortedDates.map(date => groupedByDate[date]);
                labelText = selectedExercise;
              }
            }

            if (chartInstance.current) { chartInstance.current.destroy(); }
            
            if (data.length > 0) {
              const ctx = canvasRef.current.getContext('2d');
              chartInstance.current = new Chart(ctx, {
                type: 'line',
                data: {
                  labels,
                  datasets: [{
                    label: labelText,
                    data,
                    borderColor: '#0f172a',
                    backgroundColor: 'rgba(15, 23, 42, 0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#0f172a',
                    pointRadius: 4,
                    pointHoverRadius: 6
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { display: false } },
                  scales: {
                    y: { beginAtZero: false, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } },
                    x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                  }
                }
              });
            }
          }
        }, [isOpen, weights, records, activeTab, selectedExercise, t]);

        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 z-[1000] flex items-center justify-center p-4 modal-backdrop fade-in">
            <div className="bg-white w-full max-sm rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
              <div className="px-6 pt-6 pb-2 flex justify-between items-center border-b border-slate-50">
                <h2 className="text-xl font-black text-slate-900 tracking-tight">{t.progress}</h2>
                <button onClick={onClose} className="p-2 -mr-2 text-slate-400">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <div className="px-6 pt-4">
                <div className="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-xl">
                  <button onClick={() => setActiveTab('body')} className={`py-2 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${activeTab === 'body' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}>{t.bodyWeight}</button>
                  <button onClick={() => setActiveTab('exercises')} className={`py-2 rounded-lg text-[10px] font-black uppercase tracking-wider transition-all ${activeTab === 'exercises' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500'}`}>{t.exerciseStats}</button>
                </div>
              </div>

              <div className="flex-1 flex flex-col min-h-[350px]">
                {activeTab === 'exercises' && (
                  <div className="p-6 pb-0">
                    <select value={selectedExercise} onChange={(e) => setSelectedExercise(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold text-slate-700 custom-select focus:ring-2 focus:ring-slate-900 focus:outline-none">
                      <option value="" disabled>{t.selectExercise}</option>
                      {knownExercises.map(ex => (<option key={ex} value={ex}>{ex}</option>))}
                    </select>
                  </div>
                )}
                <div className="flex-1 relative p-6">
                  {(activeTab === 'body' ? Object.keys(weights).filter(k => weights[k] !== '' && weights[k] !== null).length > 0 : (selectedExercise && records.some(r => r.description.trim() === selectedExercise && (r.val1 || r.val2 || r.val3)))) ? (
                    <canvas ref={canvasRef}></canvas>
                  ) : (
                    <div className="h-full flex flex-col items-center justify-center text-slate-300 gap-4">
                      <p className="text-sm font-bold uppercase tracking-widest text-center">{t.noData}</p>
                    </div>
                  )}
                </div>
              </div>
              <div className="px-6 pb-6 pt-2">
                <button onClick={onClose} className="w-full py-3 bg-slate-100 text-slate-900 font-bold rounded-xl active:scale-95">{t.close}</button>
              </div>
            </div>
          </div>
        );
      };

      const TrackerItem = ({ record, index, onDelete, onUpdate, onDragStart, onDragOver, onDragEnd, isDragging, uiSettings, mode, knownItems, t }) => {
        const [isConfirming, setIsConfirming] = useState(false);
        const [showSuggestions, setShowSuggestions] = useState(false);
        const [isExpanded, setIsExpanded] = useState(false);
        const textRef = useRef(null);
        const notesAreaRef = useRef(null);
        const confirmTimeout = useRef(null);
        const suggestionsRef = useRef(null);

        useEffect(() => {
          if (record.isNew && textRef.current && mode !== 'pressure') {
            textRef.current.focus();
            onUpdate(record.id, 'isNew', false);
          }
        }, []);

        const filteredSuggestions = useMemo(() => {
          if (!record.description || record.description.length < 1) return [];
          const query = record.description.toLowerCase().trim();
          
          if (mode === 'kbzhu') {
            return knownItems.filter(item => item.name.toLowerCase().includes(query) && item.name.toLowerCase() !== query).slice(0, 5);
          }
          return knownItems.filter(item => item.toLowerCase().includes(query) && item.toLowerCase() !== query).slice(0, 5);
        }, [record.description, knownItems, mode]);

        const handleDeleteClick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (isConfirming) { onDelete(record.id); } else {
            setIsConfirming(true);
            if (confirmTimeout.current) clearTimeout(confirmTimeout.current);
            confirmTimeout.current = setTimeout(() => setIsConfirming(false), 3000);
          }
        };

        const handleSuggestionClick = (suggestion) => {
          if (mode === 'kbzhu') {
            onUpdate(record.id, 'description', suggestion.name);
            onUpdate(record.id, 'val1', suggestion.k || '0');
            onUpdate(record.id, 'val2', suggestion.b || '0');
            onUpdate(record.id, 'val3', suggestion.j || '0');
            onUpdate(record.id, 'val4', suggestion.u || '0');
          } else {
            onUpdate(record.id, 'description', suggestion);
          }
          setShowSuggestions(false);
        };

        const handleBlur = (field) => {
          setTimeout(() => setShowSuggestions(false), 200);
          const finalVal = (record[field] || "").trim();
          if (finalVal !== record[field]) {
            onUpdate(record.id, field, finalVal);
          }
        };

        const handleWeightInput = (val) => {
          const cleaned = val.replace(',', '.').replace(/[^0-9.]/g, '');
          const parts = cleaned.split('.');
          const finalVal = parts.length > 2 ? `${parts[0]}.${parts.slice(1).join('')}` : cleaned;
          onUpdate(record.id, 'weight', finalVal.slice(0, 4));
        };

        const toggleExpanded = () => { if (mode === 'cook') setIsExpanded(!isExpanded); };

        const hasSuggestions = showSuggestions && filteredSuggestions.length > 0;

        const itemStyles = {
          height: isExpanded ? 'auto' : `${uiSettings.itemHeight + (mode === 'pressure' ? 12 : 0)}px`,
          width: `${uiSettings.itemWidth}%`,
          marginBottom: `${uiSettings.itemSpacing}px`,
          backgroundColor: 'white',
          borderWidth: '1px',
          borderColor: '#e2e8f0',
          zIndex: hasSuggestions ? 500 : (isExpanded ? 10 : 1),
          overflow: hasSuggestions ? 'visible' : 'hidden',
          position: 'relative',
          paddingBottom: isExpanded ? '12px' : '0px'
        };

        if (record.isCompleted && record.isHighlighted && (mode === 'gym' || mode === 'cook' || mode === 'kbzhu')) {
           itemStyles.backgroundColor = uiSettings.completedColor;
           itemStyles.borderColor = uiSettings.highlightColor;
           itemStyles.boxShadow = `0 0 0 2px ${uiSettings.highlightColor} inset`;
        } else if (record.isCompleted) {
           itemStyles.backgroundColor = uiSettings.completedColor;
           itemStyles.borderColor = '#cbd5e1';
        } else if (record.isHighlighted && (mode === 'gym' || mode === 'cook' || mode === 'kbzhu')) {
           itemStyles.backgroundColor = uiSettings.highlightColor;
           itemStyles.borderColor = '#cbd5e1';
        }

        const formattedTime = record.createdAt ? new Date(record.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }) : '--:--';

        return (
          <div draggable={mode !== 'cook' && mode !== 'kbzhu'} onDragStart={mode !== 'cook' && mode !== 'kbzhu' ? (e) => onDragStart(e, index) : null} onDragOver={mode !== 'cook' && mode !== 'kbzhu' ? (e) => onDragOver(e, index) : null} onDragEnd={mode !== 'cook' && mode !== 'kbzhu' ? onDragEnd : null} style={itemStyles} onClick={toggleExpanded} className={`rounded-lg px-0.5 flex flex-col shadow-sm fade-in tracker-item transition-all duration-200 self-center ${isDragging ? 'dragging' : ''}`}>
            <div className="flex items-center w-full" style={{ height: `${uiSettings.itemHeight}px` }}>
              {mode !== 'cook' && mode !== 'kbzhu' ? (
                <div className="flex items-center drag-handle px-0.5 shrink-0 h-full" onClick={(e) => e.stopPropagation()}>
                  <div className="flex flex-col gap-0.5 opacity-20">
                    {[1, 2, 3].map(i => (<div key={i} className="flex gap-0.5"><div className="w-0.5 h-0.5 bg-slate-900 rounded-full"></div><div className="w-0.5 h-0.5 bg-slate-900 rounded-full"></div></div>))}
                  </div>
                </div>
              ) : mode === 'cook' ? (
                <div className="shrink-0 pl-1 pr-1 text-slate-400">
                  <svg className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M19 9l-7 7-7-7" /></svg>
                </div>
              ) : (
                <div className="shrink-0 w-1"></div>
              )}
              
              <div className="flex-col items-center gap-0.5 shrink-0 px-0.5 py-0.5 flex" onClick={(e) => e.stopPropagation()}>
                {(mode === 'gym') && (
                  <button onClick={() => onUpdate(record.id, 'isHighlighted', !record.isHighlighted)} className={`p-0.5 transition-all active:scale-90 ${record.isHighlighted ? 'text-slate-700' : 'text-slate-300'}`}>
                    <svg className="w-3.5 h-3.5" fill={record.isHighlighted ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" strokeWidth="4" /></svg>
                  </button>
                )}
                {mode !== 'pressure' && mode !== 'cook' && (
                  <button onClick={() => onUpdate(record.id, 'isCompleted', !record.isCompleted)} className={`transition-all active:scale-90 ${mode === 'shop' ? 'p-1.5' : 'p-0.5'} ${record.isCompleted ? 'text-emerald-600' : 'text-slate-300'}`}>
                    <svg className={mode === 'shop' ? "w-5 h-5" : "w-3.5 h-3.5"} fill={record.isCompleted ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={6} d="M5 13l4 4L19 7" /></svg>
                  </button>
                )}
              </div>
              
              <div className="flex-1 min-w-0 h-full flex flex-col justify-center gap-0 ml-1 relative">
                {mode === 'gym' ? (
                  <React.Fragment>
                    <div className="flex items-center gap-1.5 pr-1">
                      <div className="flex-1 relative" onClick={(e) => e.stopPropagation()}>
                        <input ref={textRef} type="text" value={record.description} onFocus={() => setShowSuggestions(true)} onBlur={() => handleBlur('description')} onChange={(e) => { onUpdate(record.id, 'description', e.target.value); setShowSuggestions(true); }} placeholder={t.recordPlaceholder} style={{ fontSize: `${uiSettings.fontSize || 12}px` }} className={`font-black bg-transparent border-none outline-none focus:ring-0 placeholder:text-slate-300 w-full p-0 m-0 leading-tight truncate ${(record.isHighlighted && mode === 'gym') || record.isCompleted ? 'text-black' : 'text-slate-800'} ${record.isCompleted ? 'opacity-50' : ''}`} />
                        {hasSuggestions && (<div className="suggestions-list" ref={suggestionsRef}>{filteredSuggestions.map(s => (<div key={s} onMouseDown={() => handleSuggestionClick(s)} className="suggestion-item">{s}</div>))}</div>)}
                      </div>
                      <div className="shrink-0 flex items-center bg-slate-100/30 rounded px-1 border border-slate-200/50" onClick={(e) => e.stopPropagation()}>
                        <input type="text" inputMode="decimal" maxLength={4} value={record.weight || ''} onChange={(e) => handleWeightInput(e.target.value)} placeholder={t.weightPlaceholder} style={{ fontSize: `${(uiSettings.fontSize || 12) - 1}px`, color: uiSettings.weightColor || '#475569' }} className="w-9 text-center bg-transparent border-none outline-none focus:ring-0 p-0 m-0 font-bold placeholder:text-slate-300 tabular-nums" />
                      </div>
                    </div>
                    <div onClick={(e) => e.stopPropagation()}>
                      <input type="text" value={record.notes || ''} onBlur={() => handleBlur('notes')} onChange={(e) => onUpdate(record.id, 'notes', e.target.value)} placeholder={t.notesPlaceholder} style={{ fontSize: `${uiSettings.fontSize || 12}px` }} className={`font-black bg-transparent border-none outline-none focus:ring-0 placeholder:text-slate-300 w-full p-0 m-0 leading-tight truncate ${record.isCompleted ? 'opacity-40' : 'opacity-60 text-slate-500'}`} />
                    </div>
                  </React.Fragment>
                ) : mode === 'shop' ? (
                  <div className="relative w-full" onClick={(e) => e.stopPropagation()}>
                    <textarea ref={textRef} rows={uiSettings.lineCount || 2} value={record.description} onFocus={() => setShowSuggestions(true)} onBlur={() => handleBlur('description')} onChange={(e) => { onUpdate(record.id, 'description', e.target.value); setShowSuggestions(true); }} placeholder={t.shopPlaceholder} style={{ fontSize: `${uiSettings.fontSize || 12}px` }} className={`font-semibold bg-transparent border-none outline-none focus:ring-0 placeholder:text-slate-300 w-full p-0 m-0 leading-tight resize-none ${record.isCompleted ? 'opacity-50 strike-through text-slate-400' : 'text-slate-700'}`} />
                    {hasSuggestions && (<div className="suggestions-list" ref={suggestionsRef}>{filteredSuggestions.map(s => (<div key={s} onMouseDown={() => handleSuggestionClick(s)} className="suggestion-item">{s}</div>))}</div>)}
                  </div>
                ) : (mode === 'cook' || mode === 'kbzhu') ? (
                  <div className="flex items-center gap-2 pr-1">
                    <div className="flex-1 relative" onClick={(e) => e.stopPropagation()}>
                      <input ref={textRef} type="text" value={record.description} onFocus={() => setShowSuggestions(true)} onBlur={() => handleBlur('description')} onChange={(e) => { onUpdate(record.id, 'description', e.target.value); setShowSuggestions(true); }} placeholder={mode === 'cook' ? t.cookPlaceholder : t.kbzhuPlaceholder} style={{ fontSize: `${uiSettings.fontSize || 14}px` }} className={`font-black bg-transparent border-none outline-none focus:ring-0 placeholder:text-slate-300 w-full p-0 m-0 leading-tight truncate ${record.isCompleted ? 'opacity-50' : 'text-slate-800'}`} />
                      {hasSuggestions && (<div className="suggestions-list" ref={suggestionsRef}>{filteredSuggestions.map(s => (<div key={s} onMouseDown={() => handleSuggestionClick(s)} className="suggestion-item">{mode === 'kbzhu' ? s.name : s}</div>))}</div>)}
                    </div>
                    {mode === 'kbzhu' && (
                      <div className="shrink-0 flex items-center gap-1">
                        <div className="flex gap-0.5 items-center bg-slate-100/30 rounded px-1 border border-slate-200/50" onClick={(e) => e.stopPropagation()}>
                           {['val1', 'val2', 'val3', 'val4'].map((f, i) => {
                             const isMacro = i > 0;
                             return (
                               <div key={f} className="flex flex-col items-center">
                                 <span className="text-[6px] font-black text-slate-400 leading-none uppercase">{['–∫','–±','–∂','—É'][i]}</span>
                                 <input type="text" inputMode={isMacro ? "decimal" : "numeric"} maxLength={isMacro ? 5 : 4} value={record[f] || ''} onChange={(e) => { let val = e.target.value; if (isMacro) { val = val.replace(',', '.').replace(/[^0-9.]/g, ''); const parts = val.split('.'); if (parts.length > 2) val = `${parts[0]}.${parts.slice(1).join('')}`; onUpdate(record.id, f, val.slice(0, 5)); } else { onUpdate(record.id, f, val.replace(/\D/g, '').slice(0, 4)); } }} className={`${isMacro ? 'w-7' : 'w-6'} h-5 text-center bg-transparent border-none outline-none p-0 text-[10px] font-black text-slate-900 focus:ring-0`} placeholder="0" />
                               </div>
                             );
                           })}
                        </div>
                        <div className="shrink-0 flex items-center bg-slate-100/30 rounded px-1 border border-slate-200/50" onClick={(e) => e.stopPropagation()}>
                          <input type="text" inputMode="decimal" maxLength={4} value={record.weight || ''} onChange={(e) => handleWeightInput(e.target.value)} placeholder={t.weightPlaceholder} style={{ fontSize: `${(uiSettings.fontSize || 12)}px` }} className="w-9 text-center bg-transparent border-none outline-none focus:ring-0 p-0 m-0 font-black placeholder:text-slate-300 tabular-nums text-slate-900" />
                          <span className="text-[10px] font-black text-slate-400 ml-0.5">{t.gr}</span>
                        </div>
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="flex flex-col gap-0 w-full pr-1" onClick={(e) => e.stopPropagation()}>
                    <div className="flex items-center gap-1.5 w-full">
                      <div className="flex flex-col items-start gap-0.5 mr-1"><span className="text-[8px] font-black uppercase text-slate-400 leading-none">{t.timeLabel}</span><span className="text-[11px] font-black text-slate-600 tabular-nums leading-none">{formattedTime}</span></div>
                      <div className="flex-1 flex gap-1.5 items-center justify-between">
                        <div className="flex items-center gap-1 min-w-0"><span className="text-[7px] font-black uppercase text-slate-400 leading-none">{t.upperLabel}</span><input type="text" inputMode="numeric" maxLength={3} value={record.val1 || ''} onChange={(e) => onUpdate(record.id, 'val1', e.target.value.replace(/\D/g, '').slice(0, 3))} className="w-9 h-7 text-center bg-slate-50/50 border border-slate-100 rounded p-0 text-sm font-black text-slate-900 focus:outline-none focus:border-slate-300" placeholder="0" /></div>
                        <div className="flex items-center gap-1 min-w-0"><span className="text-[7px] font-black uppercase text-slate-400 leading-none">{t.lowerLabel}</span><input type="text" inputMode="numeric" maxLength={3} value={record.val2 || ''} onChange={(e) => onUpdate(record.id, 'val2', e.target.value.replace(/\D/g, '').slice(0, 3))} className="w-9 h-7 text-center bg-slate-50/50 border border-slate-100 rounded p-0 text-sm font-black text-slate-900 focus:outline-none focus:border-slate-300" placeholder="0" /></div>
                        <div className="flex items-center gap-1 min-w-0"><span className="text-[7px] font-black uppercase text-slate-400 leading-none">{t.pulseLabel}</span><input type="text" inputMode="numeric" maxLength={3} value={record.val3 || ''} onChange={(e) => onUpdate(record.id, 'val3', e.target.value.replace(/\D/g, '').slice(0, 3))} className="w-9 h-7 text-center bg-slate-50/50 border border-slate-100 rounded p-0 text-sm font-black text-slate-900 focus:outline-none focus:border-slate-300" placeholder="0" /></div>
                      </div>
                    </div>
                    <div className="pl-1 -mt-0.5"><input type="text" value={record.notes || ''} onBlur={() => handleBlur('notes')} onChange={(e) => onUpdate(record.id, 'notes', e.target.value)} placeholder={t.commentPlaceholder} style={{ fontSize: `${(uiSettings.fontSize || 12) - 3}px` }} className="font-black bg-transparent border-none outline-none focus:ring-0 placeholder:text-slate-300 w-full p-0 m-0 leading-tight opacity-50 text-slate-500 truncate" /></div>
                  </div>
                )}
              </div>

              {mode === 'gym' && (
                <div className="flex items-center gap-0.5 shrink-0 px-0.5" onClick={(e) => e.stopPropagation()}>
                  {['val1', 'val2', 'val3'].map((f) => (<input key={f} type="text" inputMode="numeric" value={record[f] || ''} onChange={(e) => onUpdate(record.id, f, e.target.value.replace(/\D/g, '').slice(0, 3))} className={`w-6 h-6 text-center border border-slate-100 rounded-md text-[11px] font-bold focus:outline-none focus:border-slate-400 bg-slate-50/50 shadow-inner p-0 ${record.isHighlighted || record.isCompleted ? 'text-black' : 'text-slate-900'}`} placeholder="0" />))}
                </div>
              )}
              <button onClick={handleDeleteClick} className={`w-7 h-7 shrink-0 flex items-center justify-center transition-all ${isConfirming ? 'delete-btn-active' : 'text-slate-900'}`}>
                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
              </button>
            </div>
            {mode === 'cook' && (
              <div className={`expanded-content px-2 ${isExpanded ? 'show' : ''}`} onClick={(e) => e.stopPropagation()}>
                <textarea ref={notesAreaRef} value={record.notes || ''} onChange={(e) => onUpdate(record.id, 'notes', e.target.value)} onBlur={() => handleBlur('notes')} placeholder={t.recipeContentPlaceholder} rows={8} style={{ fontSize: `${(uiSettings.fontSize || 12) - 1}px` }} className="w-full bg-slate-50/50 border border-slate-100 rounded-xl p-3 font-bold text-slate-700 focus:outline-none focus:border-slate-300 placeholder:text-slate-300" />
              </div>
            )}
          </div>
        );
      };

      const App = () => {
        const [records, setRecords] = useState([]);
        const [weights, setWeights] = useState({});
        const [sessions, setSessions] = useState({});
        const [language, setLanguage] = useState(localStorage.getItem('gt_lang') || 'ru');
        const [mode, setMode] = useState(localStorage.getItem('gt_mode') || 'gym');
        
        const [exerciseRegistry, setExerciseRegistry] = useState(() => { const saved = localStorage.getItem('gt_exercise_registry'); return saved ? JSON.parse(saved) : []; });
        const [shopRegistry, setShopRegistry] = useState(() => { const saved = localStorage.getItem('gt_shop_registry'); return saved ? JSON.parse(saved) : []; });
        const [cookRegistry, setCookRegistry] = useState(() => { const saved = localStorage.getItem('gt_cook_registry'); return saved ? JSON.parse(saved) : []; });
        const [kbzhuRegistry, setKbzhuRegistry] = useState(() => {
          const saved = localStorage.getItem('gt_kbzhu_registry');
          if (!saved) return [];
          try {
            const parsed = JSON.parse(saved);
            return parsed.map(item => typeof item === 'string' ? { name: item, k: '0', b: '0', j: '0', u: '0' } : item);
          } catch(e) { return []; }
        });

        const [shopListRegistry, setShopListRegistry] = useState(() => { const saved = localStorage.getItem('gt_shop_list_registry'); if (!saved) return []; try { const parsed = JSON.parse(saved); return parsed.map(item => typeof item === 'string' ? { name: item, enabled: false } : item); } catch(e) { return []; } });

        const t = useMemo(() => i18n[language], [language]);

        const [shopListName, setShopListName] = useState(localStorage.getItem('gt_shop_list_name') || "");
        const [cookSearchQuery, setCookSearchQuery] = useState("");
        const [kbzhuResults, setKbzhuResults] = useState(null);
        
        const [uiSettings, setUiSettings] = useState(() => {
          const saved = localStorage.getItem('gt_ui_settings_v7');
          if (saved) return JSON.parse(saved);
          return {
            gym: { itemHeight: 48, itemWidth: 100, itemSpacing: 12, backgroundColor: '#f8fafc', highlightColor: '#f1f5f9', completedColor: '#ecfdf5', weightColor: '#475569', fontSize: 13, lineCount: 2, toastDuration: 3, maxWorkoutTime: 4, enableToasts: true },
            shop: { itemHeight: 40, itemWidth: 95, itemSpacing: 8, backgroundColor: '#fff1f2', highlightColor: '#f1f5f9', completedColor: '#fef2f2', fontSize: 14, lineCount: 1, toastDuration: 3, enableToasts: true },
            pressure: { itemHeight: 44, itemWidth: 100, itemSpacing: 10, backgroundColor: '#f0f9ff', highlightColor: '#f1f5f9', completedColor: '#f8fafc', fontSize: 13, lineCount: 1, toastDuration: 3, enableToasts: true },
            cook: { itemHeight: 48, itemWidth: 100, itemSpacing: 12, backgroundColor: '#fffbeb', highlightColor: '#fef3c7', completedColor: '#fffbeb', fontSize: 14, lineCount: 1, toastDuration: 3, enableToasts: true },
            kbzhu: { itemHeight: 48, itemWidth: 100, itemSpacing: 10, backgroundColor: '#f0fdf4', highlightColor: '#dcfce7', completedColor: '#f0fdf4', fontSize: 14, lineCount: 1, toastDuration: 3, enableToasts: true }
          };
        });
        const [viewDate, setViewDate] = useState(new Date());
        const [toast, setToast] = useState({ show: false, message: '' });
        const [isLoaded, setIsLoaded] = useState(false);
        const [isStatsOpen, setIsStatsOpen] = useState(false);
        const [isCalendarOpen, setIsCalendarOpen] = useState(false);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [isListDropdownOpen, setIsListDropdownOpen] = useState(false);
        const [draggedIdx, setDraggedIdx] = useState(null);
        const [isDraggingInProgress, setIsDraggingInProgress] = useState(false);
        const [isClearConfirming, setIsClearConfirming] = useState(false);
        const [isListDeleteConfirming, setIsListDeleteConfirming] = useState(false);
        const clearConfirmTimeout = useRef(null);
        const listDeleteConfirmTimeout = useRef(null);
        const importFileRef = useRef(null);
        const [now, setNow] = useState(Date.now());
        const longPressTimer = useRef(null);
        const isLongPressActive = useRef(false);

        const viewDateKey = useMemo(() => getDateKey(viewDate), [viewDate]);
        const knownExercises = useMemo(() => Array.from(new Set(exerciseRegistry)).sort((a,b) => a.localeCompare(b)), [exerciseRegistry]);
        const knownShopItems = useMemo(() => { const currentListConfig = shopListRegistry.find(l => l.name === shopListName); if (currentListConfig && currentListConfig.enabled) return Array.from(new Set(shopRegistry)).sort((a,b) => a.localeCompare(b)); return []; }, [shopRegistry, shopListRegistry, shopListName]);
        const knownCookItems = useMemo(() => Array.from(new Set(cookRegistry)).sort((a,b) => a.localeCompare(b)), [cookRegistry]);
        const knownKbzhuItems = useMemo(() => Array.from(new Set(kbzhuRegistry)).sort((a,b) => a.name.localeCompare(b.name)), [kbzhuRegistry]);
        const allShopListsNames = useMemo(() => shopListRegistry.map(l => l.name), [shopListRegistry]);

        const currentRecords = useMemo(() => {
          if (mode === 'gym') return records.filter(r => r.dateKey === viewDateKey && (r.mode === 'gym' || !r.mode));
          if (mode === 'shop') return records.filter(r => r.mode === 'shop' && r.listName === (shopListName || ""));
          if (mode === 'pressure') return records.filter(r => r.dateKey === viewDateKey && r.mode === 'pressure');
          if (mode === 'cook') { let f = records.filter(r => r.mode === 'cook'); if (cookSearchQuery.trim()) { const q = cookSearchQuery.toLowerCase(); f = f.filter(r => r.description.toLowerCase().includes(q)); } return f.sort((a, b) => (a.description || "").localeCompare(b.description || "", language === 'ru' ? 'ru' : 'en')); }
          if (mode === 'kbzhu') return records.filter(r => r.mode === 'kbzhu');
          return [];
        }, [records, viewDateKey, mode, shopListName, cookSearchQuery, language]);

        const currentWeight = weights[viewDateKey] || '';
        const displayDate = viewDate.toLocaleDateString(language === 'ru' ? 'ru-RU' : 'en-US', { day: '2-digit', month: '2-digit', year: '2-digit' });

        const currentSessionDuration = useMemo(() => {
          const sess = sessions[viewDateKey];
          if (!sess || !sess.start) return null;
          const endTime = sess.end || now;
          const diffMs = endTime - sess.start;
          const maxMs = (uiSettings.gym?.maxWorkoutTime || 4) * 3600000;
          const effectiveMs = Math.max(0, Math.min(diffMs, maxMs));
          const h = Math.floor(effectiveMs / 3600000);
          const m = Math.floor((effectiveMs % 3600000) / 60000);
          const s = Math.floor((effectiveMs % 60000) / 1000);
          return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }, [sessions, viewDateKey, now, uiSettings.gym?.maxWorkoutTime]);

        useEffect(() => { localStorage.setItem('gt_lang', language); }, [language]);
        useEffect(() => { localStorage.setItem('gt_mode', mode); }, [mode]);
        useEffect(() => { localStorage.setItem('gt_ui_settings_v7', JSON.stringify(uiSettings)); }, [uiSettings]);
        useEffect(() => { localStorage.setItem('gt_shop_list_name', shopListName); }, [shopListName]);
        useEffect(() => { localStorage.setItem('gt_shop_list_registry', JSON.stringify(shopListRegistry)); }, [shopListRegistry]);
        useEffect(() => { localStorage.setItem('gt_exercise_registry', JSON.stringify(exerciseRegistry)); }, [exerciseRegistry]);
        useEffect(() => { localStorage.setItem('gt_shop_registry', JSON.stringify(shopRegistry)); }, [shopRegistry]);
        useEffect(() => { localStorage.setItem('gt_cook_registry', JSON.stringify(cookRegistry)); }, [cookRegistry]);
        useEffect(() => { localStorage.setItem('gt_kbzhu_registry', JSON.stringify(kbzhuRegistry)); }, [kbzhuRegistry]);

        useEffect(() => {
          const init = async () => {
            try {
              const [savedRecords, savedWeights, savedSessions] = await Promise.all([loadFromDB(), loadWeightsFromDB(), loadSessionsFromDB()]);
              if (savedRecords) { const updated = savedRecords.map(r => r.dateKey ? r : { ...r, dateKey: getDateKey(r.createdAt || Date.now()) }); setRecords(updated); }
              if (savedWeights) setWeights(savedWeights);
              if (savedSessions) setSessions(savedSessions);
              setIsLoaded(true);
            } catch (err) { setIsLoaded(true); }
          };
          init();
        }, []);

        useEffect(() => { if (mode === 'gym') { const s = sessions[viewDateKey]; if (s && s.start && !s.end) { const i = setInterval(() => setNow(Date.now()), 1000); return () => clearInterval(i); } } }, [sessions, viewDateKey, mode]);
        useEffect(() => { if (isLoaded && !isDraggingInProgress) { saveToDB(records).catch(console.error); } }, [records, isLoaded, isDraggingInProgress]);

        const showToast = (message, force = false) => { const s = uiSettings[mode] || {}; if (!force && s.enableToasts === false) return; setToast({ show: true, message }); setTimeout(() => setToast({ show: false, message: '' }), (s.toastDuration || 3) * 1000); };
        const changeDate = (offset) => { setViewDate(prev => { const n = new Date(prev); n.setDate(n.getDate() + offset); return n; }); };
        const changeShopList = (offset) => { const l = allShopListsNames; const ci = l.indexOf(shopListName); if (offset === 1) { if (ci === -1) setShopListName(l.length > 0 ? l[0] : ""); else if (ci === l.length - 1) setShopListName(""); else setShopListName(l[ci + 1]); } else { if (ci === -1) setShopListName(l.length > 0 ? l[l.length - 1] : ""); else if (ci === 0) setShopListName(""); else setShopListName(l[ci - 1]); } };
        const toggleMode = () => { const mArr = ['gym', 'shop', 'pressure', 'cook', 'kbzhu']; const ni = (mArr.indexOf(mode) + 1) % mArr.length; setMode(mArr[ni]); setCookSearchQuery(""); setKbzhuResults(null); setIsListDropdownOpen(false); };
        const handleManualSave = async () => { try { if (mode === 'shop' && shopListName.trim() && !allShopListsNames.includes(shopListName.trim())) setShopListRegistry(prev => [...prev, { name: shopListName.trim(), enabled: false }]); await Promise.all([saveToDB(records), saveWeightToDB(viewDateKey, currentWeight)]); showToast(t.savedToast, true); } catch (err) { showToast(t.errorToast, true); } };
        const handleWeightChange = (val) => { let c = val.replace(',', '.').replace(/[^0-9.]/g, ''); const p = c.split('.'); if (p.length > 2) c = `${p[0]}.${p.slice(1).join('')}`; const f = c.slice(0, 5); setWeights(prev => ({ ...prev, [viewDateKey]: f })); saveWeightToDB(viewDateKey, f).catch(console.error); };
        const exportJSON = () => { const s = JSON.stringify({ records, weights, uiSettings, mode, sessions, shopListRegistry, exerciseRegistry, shopRegistry, cookRegistry, kbzhuRegistry, exportedAt: new Date().toISOString() }, null, 2); const b = new Blob([s], { type: 'application/json' }); const u = URL.createObjectURL(b); const l = document.createElement('a'); l.href = u; l.download = `tracker-export-${new Date().toISOString().split('T')[0]}.json`; l.click(); URL.revokeObjectURL(u); showToast(t.exportToast, true); };
        const importJSON = (ev) => { const f = ev.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = async (e) => { try { const d = JSON.parse(e.target.result); if (d.records) setRecords(d.records); if (d.weights) setWeights(d.weights); if (d.uiSettings) setUiSettings(p => ({ ...p, ...d.uiSettings })); if (d.mode) setMode(d.mode); if (d.sessions) setSessions(d.sessions); if (d.shopListRegistry) setShopListRegistry(d.shopListRegistry.map(it => typeof it === 'string' ? { name: it, enabled: false } : it)); if (d.exerciseRegistry) setExerciseRegistry(d.exerciseRegistry); if (d.shopRegistry) setShopRegistry(d.shopRegistry); if (d.cookRegistry) setCookRegistry(d.cookRegistry); if (d.kbzhuRegistry) setKbzhuRegistry(d.kbzhuRegistry.map(it => typeof it === 'string' ? { name: it, k: '0', b: '0', j: '0', u: '0' } : it)); if (d.records) await saveToDB(d.records); if (d.weights) for (const [dk, w] of Object.entries(d.weights)) await saveWeightToDB(dk, w); if (d.sessions) for (const [dk, s] of Object.entries(d.sessions)) await saveSessionToDB(dk, s); showToast(t.importToast, true); ev.target.value = ''; } catch (err) { showToast(t.errorToast, true); } }; r.readAsText(f); };
        const triggerImport = () => importFileRef.current.click();
        const addNewRecord = () => { let ln = shopListName; if (mode === 'shop') { if (!ln) { ln = t.defaultListName; setShopListName(ln); } if (ln && !allShopListsNames.includes(ln)) setShopListRegistry(p => [...p, { name: ln, enabled: false }]); } const nr = { id: String(Date.now() + Math.random()), description: '', weight: '', notes: '', val1: '', val2: '', val3: '', val4: '', isNew: true, isHighlighted: false, isCompleted: false, createdAt: Date.now(), dateKey: (mode === 'cook' || mode === 'kbzhu') ? null : viewDateKey, mode, listName: mode === 'shop' ? ln : null, sortOrder: records.length }; setRecords(p => [...p, nr]); };
        const calculateKbzhuTotals = () => { if (mode !== 'kbzhu') return; let tK=0, tB=0, tJ=0, tU=0, tW=0; currentRecords.filter(r => r.isCompleted).forEach(r => { const w = parseFloat(r.weight)||0; tK += ((parseFloat(r.val1)||0)*w)/100; tB += ((parseFloat(r.val2)||0)*w)/100; tJ += ((parseFloat(r.val3)||0)*w)/100; tU += ((parseFloat(r.val4)||0)*w)/100; tW += w; }); if (tW > 0) setKbzhuResults({ k: ((tK/tW)*100).toFixed(1), b: ((tB/tW)*100).toFixed(1), j: ((tJ/tW)*100).toFixed(1), u: ((tU/tW)*100).toFixed(1) }); else { setKbzhuResults(null); showToast(t.noData, true); } };
        const deleteAllForCurrentContext = () => { if (isClearConfirming) { if (mode === 'gym') setRecords(p => p.filter(r => !(r.dateKey === viewDateKey && (r.mode === 'gym' || !r.mode)))); else if (mode === 'shop') setRecords(p => p.filter(r => !(r.mode === 'shop' && r.listName === (shopListName || t.defaultListName)))); else if (mode === 'pressure') setRecords(p => p.filter(r => !(r.dateKey === viewDateKey && r.mode === 'pressure'))); else if (mode === 'cook') setRecords(p => p.filter(r => r.mode !== 'cook')); else if (mode === 'kbzhu') setRecords(p => p.filter(r => r.mode !== 'kbzhu')); setIsClearConfirming(false); showToast(t.clearedToast, true); } else { setIsClearConfirming(true); if (clearConfirmTimeout.current) clearTimeout(clearConfirmTimeout.current); clearConfirmTimeout.current = setTimeout(() => setIsClearConfirming(false), 3000); } };
        const handleDeleteCurrentShopList = () => { if (!shopListName) return; if (isListDeleteConfirming) { const lt = shopListName; setRecords(p => p.filter(r => !(r.mode === 'shop' && r.listName === lt))); setShopListRegistry(p => p.filter(l => l.name !== lt)); const la = allShopListsNames.filter(l => l !== lt); setShopListName(la.length > 0 ? la[0] : ""); setIsListDeleteConfirming(false); showToast(t.listDeletedToast, true); } else { setIsListDeleteConfirming(true); if (listDeleteConfirmTimeout.current) clearTimeout(listDeleteConfirmTimeout.current); listDeleteConfirmTimeout.current = setTimeout(() => setIsListDeleteConfirming(false), 3000); } };
        const onRenameShopList = (on, nn) => { if (!nn.trim() || on === nn) return; setShopListRegistry(p => p.map(l => l.name === on ? { ...l, name: nn.trim() } : l)); setRecords(p => p.map(r => (r.mode === 'shop' && r.listName === on) ? { ...r, listName: nn.trim() } : r)); if (shopListName === on) setShopListName(nn.trim()); };
        const clearRegistryOfEmptyLists = () => { const u = new Set(records.filter(r => r.mode === 'shop').map(r => r.listName)); setShopListRegistry(p => p.filter(l => u.has(l.name))); showToast(t.clearedToast, true); };
        const copyFromLastWorkout = () => { if (mode === 'gym') { const f = records.filter(r => r.mode === 'gym' || !r.mode); const pd = [...new Set(f.map(r => r.dateKey))].filter(dk => dk < viewDateKey).sort(); const ld = pd.pop(); if (!ld) { showToast(t.noPastData, true); return; } const tc = f.filter(r => r.dateKey === ld); const cl = tc.map((r, i) => ({ ...r, id: String(Date.now()+Math.random()+i), dateKey: viewDateKey, weight: r.weight, notes: r.notes, val1: '', val2: '', val3: '', isNew: false, isHighlighted: r.isHighlighted, isCompleted: false, createdAt: Date.now(), mode: 'gym', sortOrder: records.length+i })); setRecords(p => [...p, ...cl]); showToast(`${t.copySuccess} ${ld} üìã`, true); } else showToast(t.noPastData, true); };
        const updateRecord = (id, f, v) => setRecords(p => p.map(r => r.id === id ? { ...r, [f]: v } : r));
        const deleteRecord = (id) => setRecords(p => p.filter(r => r.id !== id));
        const handleStartSession = () => { const cs = sessions[viewDateKey]; let ns = Date.now(); if (!cs || !cs.start) ns = Date.now(); else if (cs.end) ns = Date.now() - (cs.end - cs.start); else return; const nS = { start: ns, end: null }; setSessions(p => ({ ...p, [viewDateKey]: nS })); saveSessionToDB(viewDateKey, nS).catch(console.error); setNow(Date.now()); };
        const handleResetSession = () => { const ns = { start: null, end: null }; setSessions(p => ({ ...p, [viewDateKey]: ns })); saveSessionToDB(viewDateKey, ns).catch(console.error); showToast(t.resetToast); if (window.navigator.vibrate) window.navigator.vibrate(50); };
        const onStartPointerDown = () => { isLongPressActive.current = false; longPressTimer.current = setTimeout(() => { isLongPressActive.current = true; handleResetSession(); }, 600); };
        const onStartPointerUp = () => { clearTimeout(longPressTimer.current); if (!isLongPressActive.current) handleStartSession(); };
        const handleFinishSession = () => { const cs = sessions[viewDateKey]; if (!cs || !cs.start || cs.end) return; const nS = { ...cs, end: Date.now() }; setSessions(p => ({ ...p, [viewDateKey]: nS })); saveSessionToDB(viewDateKey, nS).catch(console.error); setNow(Date.now()); };
        const handleDragStart = (e, i) => { setDraggedIdx(i); setIsDraggingInProgress(true); if (e.dataTransfer) { e.dataTransfer.effectAllowed = 'move'; if (e.currentTarget) { const r = e.currentTarget.getBoundingClientRect(); const x = (e.clientX && e.clientX > 0) ? (e.clientX - r.left) : (r.width / 2); const y = (e.clientY && e.clientY > 0) ? (e.clientY - r.top) : (r.height / 2); e.dataTransfer.setDragImage(e.currentTarget, x, y); } } };
        const handleDragOver = (e, i) => { e.preventDefault(); if (draggedIdx === null || draggedIdx === i) return; const im = currentRecords[draggedIdx]; const ti = currentRecords[i]; if (!im || !ti) return; setRecords(p => { const n = [...p]; const iM = n.findIndex(r => r.id === im.id); const iT = n.findIndex(r => r.id === ti.id); if (iM === -1 || iT === -1) return p; const [rem] = n.splice(iM, 1); n.splice(iT, 0, rem); return n.map((r, idx) => ({ ...r, sortOrder: idx })); }); setDraggedIdx(i); };
        const handleDragEnd = () => { setDraggedIdx(null); setIsDraggingInProgress(false); };

        if (!isLoaded) return null;
        const sSA = !!sessions[viewDateKey]?.start && !sessions[viewDateKey]?.end;
        const sP = !!sessions[viewDateKey]?.start && !!sessions[viewDateKey]?.end;
        const cAB = uiSettings[mode]?.backgroundColor || '#f8fafc';

        return (
          <div className="min-h-screen max-w-md mx-auto flex flex-col relative pb-10 transition-colors duration-500" style={{ backgroundColor: cAB }}>
            <div className={`toast ${toast.show ? 'show' : ''}`}>{toast.message}</div>
            <StatsModal isOpen={isStatsOpen} onClose={() => setIsStatsOpen(false)} weights={weights} records={records} knownExercises={knownExercises} t={t} />
            <CalendarModal isOpen={isCalendarOpen} onClose={() => setIsCalendarOpen(false)} selectedDate={viewDate} setSelectedDate={setViewDate} records={records} t={t} />
            <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} language={language} setLanguage={setLanguage} uiSettings={uiSettings} setUiSettings={setUiSettings} activeMode={mode} exerciseRegistry={exerciseRegistry} setExerciseRegistry={setExerciseRegistry} shopRegistry={shopRegistry} setShopRegistry={setShopRegistry} cookRegistry={cookRegistry} setCookRegistry={setCookRegistry} kbzhuRegistry={kbzhuRegistry} setKbzhuRegistry={setKbzhuRegistry} shopListRegistry={shopListRegistry} setShopListRegistry={setShopListRegistry} onRenameShopList={onRenameShopList} clearRegistry={clearRegistryOfEmptyLists} t={t} />

            <header className="sticky top-0 z-40 border-b border-slate-100/50 backdrop-blur-md" style={{ backgroundColor: `${cAB}f2` }}>
              <div className="px-4 pt-1.5 pb-1"><div className="grid grid-cols-5 gap-1 bg-slate-200/40 p-0.5 rounded-lg">{['gym', 'shop', 'pressure', 'cook', 'kbzhu'].map((m) => (<button key={m} onClick={() => { setMode(m); setCookSearchQuery(""); setKbzhuResults(null); setIsListDropdownOpen(false); }} className={`py-1.5 rounded-md text-[8px] font-black uppercase tracking-wider transition-all active:scale-95 ${mode === m ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}>{m === 'gym' ? 'Gym' : m === 'shop' ? 'Shop' : m === 'pressure' ? '120/80' : m === 'cook' ? 'Cook' : '–ö–ë–ñ–£'}</button>))}</div></div>
              <div className="px-4 flex justify-between items-center mb-0.5 overflow-visible h-9">
                <div className="relative flex-1 min-w-0 h-full flex items-center">
                  <button onClick={() => mode === 'shop' && setIsListDropdownOpen(!isListDropdownOpen)} className={`flex items-center gap-1.5 text-[15px] font-black text-slate-900 tracking-tight transition-all truncate pr-2 ${mode === 'shop' ? 'hover:opacity-60 active:scale-95' : 'cursor-default'}`}>{mode === 'gym' ? t.appName : mode === 'shop' ? t.shopName : mode === 'pressure' ? t.pressureName : mode === 'cook' ? t.cookName : t.kbzhuName}{mode === 'shop' && (<svg className={`w-3 h-3 text-slate-400 transition-transform ${isListDropdownOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={4} d="M19 9l-7 7-7-7" /></svg>)}</button>
                  {isListDropdownOpen && mode === 'shop' && (<React.Fragment><div className="fixed inset-0 z-40" onClick={() => setIsListDropdownOpen(false)}></div><div className="absolute top-full left-0 mt-1 w-56 bg-white/95 backdrop-blur-sm border border-slate-200 rounded-2xl shadow-2xl z-50 overflow-hidden fade-in py-1"><div className="max-h-64 overflow-y-auto no-scrollbar">{allShopListsNames.length > 0 ? allShopListsNames.map(name => (<button key={name} onClick={(e) => { e.stopPropagation(); setShopListName(name); setIsListDropdownOpen(false); }} className={`w-full text-left px-4 py-3.5 text-xs font-black transition-colors flex items-center justify-between border-b border-slate-50 last:border-0 ${shopListName === name ? 'bg-slate-100 text-slate-900' : 'text-slate-600 hover:bg-slate-50'}`}><span className="truncate flex-1 pr-2">{name}</span>{shopListName === name && <svg className="w-4 h-4 text-emerald-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={4} d="M5 13l4 4L19 7" /></svg>}</button>)) : (<div className="px-4 py-5 text-[9px] font-black text-slate-400 italic text-center uppercase tracking-widest">{t.libraryEmpty}</div>)}</div></div></React.Fragment>)}
                </div>
                {mode === 'gym' && (<div className="flex items-center gap-1 bg-slate-200/50 rounded-lg px-1.5 py-0.5 mx-1 shrink-0"><span className="text-[7px] font-bold text-slate-500 uppercase tracking-tighter">{t.weight}</span><input type="text" inputMode="decimal" maxLength={5} value={currentWeight} onChange={(e) => handleWeightChange(e.target.value)} placeholder="--" className="w-8 bg-transparent border-none text-center text-xs font-black text-slate-900 focus:outline-none placeholder:text-slate-400" /><span className="text-[7px] font-bold text-slate-400">{t.kg}</span></div>)}
                <div className="flex items-center gap-0 shrink-0">
                  {mode === 'gym' && (<button onClick={() => setIsStatsOpen(true)} className="w-6 h-6 flex items-center justify-center text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.stats}><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg></button>)}
                  <button onClick={() => setIsSettingsOpen(true)} className="w-6 h-6 flex items-center justify-center text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.settings}><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.592c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.332.183-.582.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg></button>
                  <input type="file" ref={importFileRef} onChange={importJSON} accept=".json" className="hidden" /><button onClick={triggerImport} className="w-6 h-6 flex items-center justify-center text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.import}><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v8" /></svg></button>
                  <button onClick={exportJSON} className="w-6 h-6 flex items-center justify-center text-slate-500 hover:text-slate-900 active:scale-125 transition-transform" title={t.export}><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M8 8l4 4m0 0l4-4m-4 4V4" /></svg></button>
                  <button onClick={handleManualSave} className="w-6 h-6 flex items-center justify-center text-slate-900 hover:text-slate-900 active:scale-125 transition-transform" title={t.save}><svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg></button>
                </div>
              </div>
              <div className="px-4 pb-1">
                <div className="flex items-center justify-between bg-white/60 rounded-xl p-0.5 border border-slate-200/50 shadow-sm min-h-[40px]">
                  {mode === 'gym' || mode === 'pressure' ? (
                    <React.Fragment>
                      <div className="w-10 flex justify-center"><button onClick={() => changeDate(-1)} className="nav-btn shrink-0"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M15 19l-7-7 7-7" /></svg></button></div>
                      {mode === 'gym' ? (
                        <div className="flex-1 flex justify-center"><button onPointerDown={onStartPointerDown} onPointerUp={onStartPointerUp} onPointerLeave={() => clearTimeout(longPressTimer.current)} onContextMenu={(e) => e.preventDefault()} className={`px-3 py-1 text-[8px] font-black uppercase tracking-tighter rounded-md transition-all duration-300 select-none ${sSA ? 'bg-emerald-600 text-white shadow-md' : sP ? 'bg-amber-500 text-white' : 'bg-slate-100 text-slate-600 active:bg-slate-900 active:text-white'}`}>{sP ? t.start : t.start}</button></div>
                      ) : (
                        <div className="flex-1 flex justify-center"><span className="text-[10px] font-black uppercase tracking-widest text-slate-300">{t.pressureName}</span></div>
                      )}
                      <div onClick={() => setIsCalendarOpen(true)} className="flex flex-col items-center justify-center cursor-pointer px-1 shrink-0 min-w-[80px] hover:bg-slate-100 rounded-lg active:scale-95 transition-all"><span className="text-[10px] font-black text-slate-900 tabular-nums leading-none whitespace-nowrap mb-0.5">{displayDate}</span>{currentSessionDuration && mode === 'gym' && (<div className="flex flex-col items-center gap-0"><span className="text-[6px] font-black text-slate-400 uppercase tracking-widest leading-none mb-0.5">{t.workoutTime}</span><span className={`text-[10px] font-black tabular-nums leading-none ${sP ? 'text-slate-400' : 'text-slate-600'}`}>{currentSessionDuration}</span></div>)}</div>
                      {mode === 'gym' ? (
                        <div className="flex-1 flex justify-center"><button onClick={handleFinishSession} className={`px-3 py-1 text-[8px] font-black uppercase tracking-tighter rounded-md transition-all duration-300 ${sP ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-600 active:bg-slate-900 active:text-white'}`}>{t.finish}</button></div>
                      ) : (
                        <div className="flex-1"></div>
                      )}
                      <div className="w-10 flex justify-center"><button onClick={() => changeDate(1)} className="nav-btn shrink-0"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M9 5l7 7-7 7" /></svg></button></div>
                    </React.Fragment>
                  ) : mode === 'shop' ? (
                    <React.Fragment>
                      <button onClick={() => changeShopList(-1)} className="nav-btn shrink-0"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M15 19l-7-7 7-7" /></svg></button>
                      <div className="flex items-center flex-1 px-1 gap-1.5 min-w-0 transition-all">
                        <div className="shrink-0"><svg className="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M9 6h11M9 12h11M9 18h11M5 6v.01M5 12v.01M5 18v.01" /></svg></div>
                        <input type="text" value={shopListName} onChange={(e) => setShopListName(e.target.value)} placeholder={t.defaultListName} className={`flex-1 bg-transparent border-none outline-none text-sm font-black focus:ring-0 p-0 m-0 overflow-hidden text-ellipsis whitespace-nowrap transition-colors ${allShopListsNames.includes(shopListName.trim()) ? 'text-slate-900' : 'text-slate-400'}`} />
                      </div>
                      <button onClick={() => changeShopList(1)} className="nav-btn shrink-0"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M9 5l7 7-7 7" /></svg></button>
                      <button onClick={handleDeleteCurrentShopList} className={`nav-btn shrink-0 w-8 h-8 flex items-center justify-center transition-all duration-300 ${isListDeleteConfirming ? 'text-red-600 bg-red-50 rounded-lg scale-110' : 'text-slate-400'}`} title={t.deleteListConfirm}><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">{isListDeleteConfirming ? (<path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12" />) : (<path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />)}</svg></button>
                    </React.Fragment>
                  ) : mode === 'cook' ? (
                      <div className="flex-1 flex items-center px-3 gap-2">
                         <div className="flex-1 relative">
                            <div className="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none"><svg className="h-3 w-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                            <input type="text" value={cookSearchQuery} onChange={(e) => setCookSearchQuery(e.target.value)} placeholder={t.cookSearchPlaceholder} className="block w-full pl-7 bg-slate-100/50 border-none rounded-lg py-1.5 text-xs font-black text-slate-900 focus:ring-0 placeholder:text-slate-300 transition-all" />
                            {cookSearchQuery && (<button onClick={() => setCookSearchQuery('')} className="absolute inset-y-0 right-0 pr-2 flex items-center text-slate-400 active:text-slate-900"><svg className="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12" /></svg></button>)}
                         </div>
                      </div>
                  ) : (
                    <div className="flex-1 flex items-center justify-between px-3 gap-2 overflow-hidden">
                      <button onClick={calculateKbzhuTotals} className="px-3 py-1.5 bg-slate-900 text-white text-[9px] font-black uppercase tracking-widest rounded-lg active:scale-95 transition-all shadow-sm shrink-0">{t.calculate}</button>
                      {kbzhuResults && (<div className="flex-1 text-[9px] font-black text-slate-700 whitespace-nowrap overflow-hidden text-ellipsis text-right leading-tight">–ö: {kbzhuResults.k}, –ë: {kbzhuResults.b}, –ñ: {kbzhuResults.j}, –£: {kbzhuResults.u}</div>)}
                    </div>
                  )}
                </div>
              </div>
            </header>

            <main className="px-4 pb-12 pt-1.5 flex flex-col items-center">
              <div className="w-full flex flex-col gap-0 items-center">{currentRecords.map((r, idx) => (<TrackerItem key={r.id} record={r} index={idx} onDelete={deleteRecord} onUpdate={updateRecord} onDragStart={handleDragStart} onDragOver={handleDragOver} onDragEnd={handleDragEnd} isDragging={draggedIdx === idx} uiSettings={uiSettings[mode] || {}} mode={mode} knownItems={mode === 'gym' ? knownExercises : mode === 'shop' ? knownShopItems : mode === 'cook' ? knownCookItems : mode === 'kbzhu' ? knownKbzhuItems : []} t={t} />))}</div>
              <div className="flex flex-col gap-3 mt-1.5 w-full max-w-[95%]">
                <button onClick={addNewRecord} className="action-button w-full h-11 bg-slate-900 text-white rounded-xl flex items-center justify-center gap-2 shadow-lg"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M12 6v12m6-6H6" /></svg><span className="text-sm font-bold">{mode === 'gym' ? t.addExercise : mode === 'shop' ? t.addItem : mode === 'pressure' ? t.addPressure : mode === 'cook' ? t.addRecipe : t.addKbzhu}</span></button>
                {currentRecords.length === 0 && mode === 'gym' && (<button onClick={copyFromLastWorkout} className="action-button w-full h-11 bg-slate-900 text-white rounded-xl flex items-center justify-center gap-2 shadow-lg mb-0.5"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg><span className="text-sm font-bold">{t.repeatLast}</span></button>)}
                {currentRecords.length > 0 && (<button onClick={deleteAllForCurrentContext} className={`action-button w-full h-11 rounded-xl flex items-center justify-center gap-2 shadow-md transition-all ${isClearConfirming ? 'bg-red-500 text-white scale-[1.02]' : 'bg-white text-slate-400 border border-slate-200'}`}><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">{isClearConfirming ? (<path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M6 18L18 6M6 6l12 12" />) : (<path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />)}</svg><span className="text-xs font-bold uppercase tracking-wider">{isClearConfirming ? t.clearConfirm : t.clearBtn}</span></button>)}
              </div>
            </main>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
